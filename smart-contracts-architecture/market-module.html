<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Market Module - Satoru Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../getting-started/index.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting-started/prerequisites.html"><strong aria-hidden="true">1.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="../getting-started/build.html"><strong aria-hidden="true">1.2.</strong> Build the contracts</a></li><li class="chapter-item expanded "><a href="../getting-started/test.html"><strong aria-hidden="true">1.3.</strong> Test the contracts</a></li></ol></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/index.html"><strong aria-hidden="true">2.</strong> Smart contracts architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../smart-contracts-architecture/overview.html"><strong aria-hidden="true">2.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/adl-module.html"><strong aria-hidden="true">2.2.</strong> Adl Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/bank-module.html"><strong aria-hidden="true">2.3.</strong> Bank Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/callback-module.html"><strong aria-hidden="true">2.4.</strong> Callback Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/chain-module.html"><strong aria-hidden="true">2.5.</strong> Chain Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/config-module.html"><strong aria-hidden="true">2.6.</strong> Config Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/data-module.html"><strong aria-hidden="true">2.7.</strong> Data Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/deposit-module.html"><strong aria-hidden="true">2.8.</strong> Deposit Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/exchange-module.html"><strong aria-hidden="true">2.9.</strong> Exchange Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/feature-module.html"><strong aria-hidden="true">2.10.</strong> Feature Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/fee-module.html"><strong aria-hidden="true">2.11.</strong> Fee Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/gas-module.html"><strong aria-hidden="true">2.12.</strong> Gas Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/liquidation-module.html"><strong aria-hidden="true">2.13.</strong> Liquidation Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/market-module.html" class="active"><strong aria-hidden="true">2.14.</strong> Market Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/mock-module.html"><strong aria-hidden="true">2.15.</strong> Mock Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/nonce-module.html"><strong aria-hidden="true">2.16.</strong> Nonce Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/oracle-module.html"><strong aria-hidden="true">2.17.</strong> Oracle Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/order-module.html"><strong aria-hidden="true">2.18.</strong> Order Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/position-module.html"><strong aria-hidden="true">2.19.</strong> Position Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/price-module.html"><strong aria-hidden="true">2.20.</strong> Price Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/pricing-module.html"><strong aria-hidden="true">2.21.</strong> Pricing Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/reader-module.html"><strong aria-hidden="true">2.22.</strong> Reader Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/referral-module.html"><strong aria-hidden="true">2.23.</strong> Referral Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/role-module.html"><strong aria-hidden="true">2.24.</strong> Role Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/router-module.html"><strong aria-hidden="true">2.25.</strong> Router Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/swap-module.html"><strong aria-hidden="true">2.26.</strong> Swap Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/utils-module.html"><strong aria-hidden="true">2.27.</strong> Utils Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/withdrawal-module.html"><strong aria-hidden="true">2.28.</strong> Withdrawal Module</a></li></ol></li><li class="chapter-item expanded "><a href="../continuous-integration/index.html"><strong aria-hidden="true">3.</strong> Continuous Integration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../continuous-integration/workflows.html"><strong aria-hidden="true">3.1.</strong> Github Workflows Documentation</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Satoru Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/keep-starknet-strange/satoru/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/keep-starknet-strange/satoru/book/src/smart-contracts-architecture/market-module.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="market-module"><a class="header" href="#market-module">Market Module</a></h1>
<p>The Market Module helps with trading in different markets. It lets you create markets by choosing specific tokens. This module supports both regular and ongoing trading.</p>
<p>Example markets include:</p>
<ul>
<li>ETH/USD: Long collateral as ETH, short collateral as a stablecoin, index token as ETH.</li>
<li>BTC/USD: Long collateral as WBTC, short collateral as a stablecoin, index token as BTC.</li>
<li>STRK/USD: Long collateral as ETH, short collateral as a stablecoin, index token as STRK.</li>
</ul>
<p>In each market, liquidity providers can deposit either the long or the short collateral token, or both, to mint liquidity tokens. The module allows for risk isolation by exposing liquidity providers only to the markets they deposit into, enabling potentially permissionless listings.</p>
<p>It contains the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/market/market.cairo">market.cairo</a> </li>
</ul>
<h2 id="structures-and-types"><a class="header" href="#structures-and-types">Structures and Types</a></h2>
<h3 id="market"><a class="header" href="#market"><code>Market</code></a></h3>
<p>This struct represents a market with the following fields:</p>
<ul>
<li><code>market_token</code>: Address of the market token for the market.</li>
<li><code>index_token</code>: Address of the index token for the market.</li>
<li><code>long_token</code>: Address of the long token for the market.</li>
<li><code>short_token</code>: Address of the short token for the market.</li>
</ul>
<h2 id="functions-and-traits"><a class="header" href="#functions-and-traits">Functions and Traits</a></h2>
<h3 id="intomarkettoken"><a class="header" href="#intomarkettoken"><code>IntoMarketToken</code></a></h3>
<p>This trait provides a method to get the <code>MarketToken</code> contract interface of a market.</p>
<h3 id="uniqueidmarket"><a class="header" href="#uniqueidmarket"><code>UniqueIdMarket</code></a></h3>
<p>This trait provides a method to compute the unique id of a market based on its parameters.</p>
<h3 id="validatemarket"><a class="header" href="#validatemarket"><code>ValidateMarket</code></a></h3>
<p>This trait provides methods to validate a market, either by returning a boolean value or by asserting the validity.</p>
<h2 id="implementations"><a class="header" href="#implementations">Implementations</a></h2>
<h3 id="uniqueidmarketimpl"><a class="header" href="#uniqueidmarketimpl"><code>UniqueIdMarketImpl</code></a></h3>
<p>This is the implementation of the <code>UniqueIdMarket</code> trait for the <code>Market</code> struct, providing a method to compute the unique id of a market.</p>
<h3 id="validatemarketimpl"><a class="header" href="#validatemarketimpl"><code>ValidateMarketImpl</code></a></h3>
<p>This is the implementation of the <code>ValidateMarket</code> trait for the <code>Market</code> struct, offering methods to validate the market's state.</p>
<h3 id="markettokenimpl"><a class="header" href="#markettokenimpl"><code>MarketTokenImpl</code></a></h3>
<p>This is the implementation of the <code>IntoMarketToken</code> trait for the <code>Market</code> struct, providing the <code>MarketToken</code> contract interface of a market.</p>
<h2 id="errors"><a class="header" href="#errors">Errors</a></h2>
<p>The module incorporates a <code>MarketError</code> enum to manage market-specific errors, primarily to handle cases involving invalid market parameters. Each constant in the <code>MarketError</code> module represents a specific error case in the market module. Here are the defined errors:</p>
<ul>
<li><strong><code>MARKET_NOT_FOUND</code></strong>: Triggered when the specified market cannot be located within the system.</li>
<li><strong><code>DIVISOR_CANNOT_BE_ZERO</code></strong>: Raised when an attempt is made to divide by zero.</li>
<li><strong><code>INVALID_MARKET_PARAMS</code></strong>: Occurs when the parameters provided for the market are invalid.</li>
<li><strong><code>OPEN_INTEREST_CANNOT_BE_UPDATED_FOR_SWAP_ONLY_MARKET</code></strong>: This error is triggered when there is an attempt to update open interest for a swap-only market.</li>
<li><strong><code>MAX_OPEN_INTEREST_EXCEEDED</code></strong>: Occurs when the maximum open interest for a market is surpassed.</li>
<li><strong><code>EMPTY_ADDRESS_IN_MARKET_TOKEN_BALANCE_VALIDATION</code></strong>: Raised when an empty address is found during market token balance validation.</li>
<li><strong><code>EMPTY_ADDRESS_TOKEN_BALANCE_VAL</code></strong>: Triggered when an empty address is discovered during token balance validation.</li>
<li><strong><code>INVALID_MARKET_TOKEN_BALANCE</code></strong>: Occurs when the market token balance is found to be invalid.</li>
<li><strong><code>INVALID_MARKET_TOKEN_BALANCE_FOR_COLLATERAL_AMOUNT</code></strong>: This error is raised when the market token balance for a collateral amount is invalid.</li>
<li><strong><code>INVALID_MARKET_TOKEN_BALANCE_FOR_CLAIMABLE_FUNDING</code></strong>: Triggered when the market token balance for claimable funding is invalid.</li>
<li><strong><code>EmptyAddressInMarketTokenBalanceValidation</code></strong>: Occurs when an empty address is encountered during market token balance validation.</li>
<li><strong><code>INVALID_POSITION_MARKET</code></strong>: Raised when the market for a position is invalid.</li>
<li><strong><code>INVALID_COLLATERAL_TOKEN_FOR_MARKET</code></strong>: Triggered when an invalid collateral token is provided for the market.</li>
<li><strong><code>EMPTY_MARKET</code></strong>: Occurs when the market is found to be empty.</li>
<li><strong><code>DISABLED_MARKET</code></strong>: Triggered when the market is disabled.</li>
</ul>
<p>Additionally, there is a function <code>UNABLE_TO_GET_CACHED_TOKEN_PRICE</code> which panics with a specific message when it is unable to get the cached token price for a given token.</p>
<h2 id="usage-example"><a class="header" href="#usage-example">Usage Example</a></h2>
<pre><code class="language-cairo">let market = Market {
    market_token: /* ContractAddress of the market token */,
    index_token: /* ContractAddress of the index token */,
    long_token: /* ContractAddress of the long token */,
    short_token: /* ContractAddress of the short token */,
};

// Asserting that the market is valid
market.assert_valid();
// Getting the MarketToken contract interface of the market
let market_token_dispatcher = market.market_token();</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../smart-contracts-architecture/liquidation-module.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../smart-contracts-architecture/mock-module.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../smart-contracts-architecture/liquidation-module.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../smart-contracts-architecture/mock-module.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
