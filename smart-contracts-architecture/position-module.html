<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Position Module - Satoru Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../getting-started/index.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting-started/prerequisites.html"><strong aria-hidden="true">1.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="../getting-started/build.html"><strong aria-hidden="true">1.2.</strong> Build the contracts</a></li><li class="chapter-item expanded "><a href="../getting-started/test.html"><strong aria-hidden="true">1.3.</strong> Test the contracts</a></li></ol></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/index.html"><strong aria-hidden="true">2.</strong> Smart contracts architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../smart-contracts-architecture/overview.html"><strong aria-hidden="true">2.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/adl-module.html"><strong aria-hidden="true">2.2.</strong> Adl Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/bank-module.html"><strong aria-hidden="true">2.3.</strong> Bank Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/callback-module.html"><strong aria-hidden="true">2.4.</strong> Callback Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/chain-module.html"><strong aria-hidden="true">2.5.</strong> Chain Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/config-module.html"><strong aria-hidden="true">2.6.</strong> Config Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/data-module.html"><strong aria-hidden="true">2.7.</strong> Data Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/deposit-module.html"><strong aria-hidden="true">2.8.</strong> Deposit Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/exchange-module.html"><strong aria-hidden="true">2.9.</strong> Exchange Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/feature-module.html"><strong aria-hidden="true">2.10.</strong> Feature Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/fee-module.html"><strong aria-hidden="true">2.11.</strong> Fee Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/gas-module.html"><strong aria-hidden="true">2.12.</strong> Gas Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/liquidation-module.html"><strong aria-hidden="true">2.13.</strong> Liquidation Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/market-module.html"><strong aria-hidden="true">2.14.</strong> Market Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/mock-module.html"><strong aria-hidden="true">2.15.</strong> Mock Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/nonce-module.html"><strong aria-hidden="true">2.16.</strong> Nonce Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/oracle-module.html"><strong aria-hidden="true">2.17.</strong> Oracle Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/order-module.html"><strong aria-hidden="true">2.18.</strong> Order Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/position-module.html" class="active"><strong aria-hidden="true">2.19.</strong> Position Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/price-module.html"><strong aria-hidden="true">2.20.</strong> Price Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/pricing-module.html"><strong aria-hidden="true">2.21.</strong> Pricing Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/reader-module.html"><strong aria-hidden="true">2.22.</strong> Reader Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/referral-module.html"><strong aria-hidden="true">2.23.</strong> Referral Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/role-module.html"><strong aria-hidden="true">2.24.</strong> Role Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/router-module.html"><strong aria-hidden="true">2.25.</strong> Router Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/swap-module.html"><strong aria-hidden="true">2.26.</strong> Swap Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/utils-module.html"><strong aria-hidden="true">2.27.</strong> Utils Module</a></li><li class="chapter-item expanded "><a href="../smart-contracts-architecture/withdrawal-module.html"><strong aria-hidden="true">2.28.</strong> Withdrawal Module</a></li></ol></li><li class="chapter-item expanded "><a href="../continuous-integration/index.html"><strong aria-hidden="true">3.</strong> Continuous Integration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../continuous-integration/workflows.html"><strong aria-hidden="true">3.1.</strong> Github Workflows Documentation</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Satoru Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/keep-starknet-strange/satoru/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/keep-starknet-strange/satoru/book/src/smart-contracts-architecture/position-module.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="position-module"><a class="header" href="#position-module">Position Module</a></h1>
<p>The purpose of the position module is to help with management of positions.</p>
<h2 id="fees-in-position"><a class="header" href="#fees-in-position">Fees in position</a></h2>
<p>Borrowing fees for position require only a borrowing_factor to track. An example on how this works is if the global cumulative_borrowing_factor is 10020% a position would be opened with borrowingFactor as 10020%. After some time, if the cumulative_borrowing_factor is updated to 10025% the position would owe 5% of the position size as borrowing fees. The total pending borrowing fees of all positions is factored into the calculation of the pool value for LPs. When a position is increased or decreased, the pending borrowing fees for the position is deducted from the position's
collateral and transferred into the LP pool.</p>
<p>The same borrowing fee factor tracking cannot be applied for funding fees as those calculations consider pending funding fees based on the fiat value of the position sizes.</p>
<p>For example, if the price of the long_token is $2000 and a long position owes $200 in funding fees, the opposing short position claims the funding fees of 0.1 longToken ($200), if the price of the longToken changes to $4000 later, the long position would only owe 0.05 longToken ($200). This would result in differences between the amounts deducted and amounts paid out, for this reason, the actual token amounts to be deducted and to be paid out need to be tracked instead.</p>
<p>For funding fees, there are four values to consider:</p>
<ol>
<li>long positions with market.long_token as collateral.</li>
<li>long positions with market.short_token as collateral.</li>
<li>short positions with market.long_token as collateral.</li>
<li>short positions with market.short_token as collateral.</li>
</ol>
<hr />
<p>It contains the following files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/decrease_position_collateral_utils.cairo">decrease_position_collateral_utils.cairo</a>: Library for functions to help with the calculations when decreasing a position.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/decrease_position_swap_utils.cairo">decrease_position_swap_utils.cairo</a>: Library for functions related to decrease of position involving swaps.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/decrease_position_utils.cairo">decrease_position_utils.cairo</a>: Library for functions to help with decreasing a position.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/increase_position_utils.cairo">increase_position_utils.cairo</a>: Library for functions to help with increasing a position.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/position_event_utils.cairo">position_event_utils.cairo</a>: Library with helper functions to emit position related events.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/position_utils.cairo">position_utils.cairo</a>: Library with various utility functions for positions.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/position.cairo">position.cairo</a>: Contains main Position struct.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../smart-contracts-architecture/order-module.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../smart-contracts-architecture/price-module.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../smart-contracts-architecture/order-module.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../smart-contracts-architecture/price-module.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
