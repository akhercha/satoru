<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Satoru Book</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="getting-started/index.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="getting-started/prerequisites.html"><strong aria-hidden="true">1.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="getting-started/build.html"><strong aria-hidden="true">1.2.</strong> Build the contracts</a></li><li class="chapter-item expanded "><a href="getting-started/test.html"><strong aria-hidden="true">1.3.</strong> Test the contracts</a></li></ol></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/index.html"><strong aria-hidden="true">2.</strong> Smart contracts architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="smart-contracts-architecture/overview.html"><strong aria-hidden="true">2.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/adl-module.html"><strong aria-hidden="true">2.2.</strong> Adl Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/bank-module.html"><strong aria-hidden="true">2.3.</strong> Bank Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/callback-module.html"><strong aria-hidden="true">2.4.</strong> Callback Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/chain-module.html"><strong aria-hidden="true">2.5.</strong> Chain Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/config-module.html"><strong aria-hidden="true">2.6.</strong> Config Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/data-module.html"><strong aria-hidden="true">2.7.</strong> Data Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/deposit-module.html"><strong aria-hidden="true">2.8.</strong> Deposit Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/exchange-module.html"><strong aria-hidden="true">2.9.</strong> Exchange Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/feature-module.html"><strong aria-hidden="true">2.10.</strong> Feature Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/fee-module.html"><strong aria-hidden="true">2.11.</strong> Fee Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/gas-module.html"><strong aria-hidden="true">2.12.</strong> Gas Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/liquidation-module.html"><strong aria-hidden="true">2.13.</strong> Liquidation Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/market-module.html"><strong aria-hidden="true">2.14.</strong> Market Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/mock-module.html"><strong aria-hidden="true">2.15.</strong> Mock Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/nonce-module.html"><strong aria-hidden="true">2.16.</strong> Nonce Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/oracle-module.html"><strong aria-hidden="true">2.17.</strong> Oracle Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/order-module.html"><strong aria-hidden="true">2.18.</strong> Order Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/position-module.html"><strong aria-hidden="true">2.19.</strong> Position Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/price-module.html"><strong aria-hidden="true">2.20.</strong> Price Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/pricing-module.html"><strong aria-hidden="true">2.21.</strong> Pricing Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/reader-module.html"><strong aria-hidden="true">2.22.</strong> Reader Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/referral-module.html"><strong aria-hidden="true">2.23.</strong> Referral Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/role-module.html"><strong aria-hidden="true">2.24.</strong> Role Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/router-module.html"><strong aria-hidden="true">2.25.</strong> Router Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/swap-module.html"><strong aria-hidden="true">2.26.</strong> Swap Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/utils-module.html"><strong aria-hidden="true">2.27.</strong> Utils Module</a></li><li class="chapter-item expanded "><a href="smart-contracts-architecture/withdrawal-module.html"><strong aria-hidden="true">2.28.</strong> Withdrawal Module</a></li></ol></li><li class="chapter-item expanded "><a href="continuous-integration/index.html"><strong aria-hidden="true">3.</strong> Continuous Integration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="continuous-integration/workflows.html"><strong aria-hidden="true">3.1.</strong> Github Workflows Documentation</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Satoru Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/keep-starknet-strange/satoru/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="satoru"><a class="header" href="#satoru">Satoru</a></h1>
<p>Satoru is a cutting-edge synthetics platform for Starknet, taking inspiration from the modular design of GMX v2.</p>
<p><img src="./assets/satoru-whats-up.gif" alt="Satoru Whats Up" /></p>
<p>Like its namesake, Satoru is <strong>powerful</strong> and <strong>badass</strong>. It's also a bit of a mystery. We don't know what it's capable of yet, but we're excited to find out.</p>
<p>Combine the power of <strong>Starknet</strong> with its huge computation capacity with the great design of <strong>GMX v2</strong>, and you get Satoru, a synthetics platform that is fast, cheap and scalable.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<p>In this section, we will go through the steps to build and test the smart contracts.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h1>
<p>There are several ways to run Satoru:</p>
<ul>
<li>Install prerequisites on the local system</li>
<li>Run in a dev container</li>
</ul>
<h2 id="installation-on-the-local-system"><a class="header" href="#installation-on-the-local-system">Installation on the local system</a></h2>
<ul>
<li><a href="https://docs.swmansion.com/scarb/download.html">Scarb</a></li>
<li><a href="https://foundry-rs.github.io/starknet-foundry/">Starknet Foundry</a></li>
</ul>
<h2 id="run-in-a-dev-container"><a class="header" href="#run-in-a-dev-container">Run in a dev container</a></h2>
<p>Dev containers provide a dedicated environment for the project. Since the dev container configuration is stored in the <code>.devcontainer</code> directory, this ensures that the environment is strictly identical from one developer to the next.</p>
<p>To run inside a dev container, please follow <a href="https://code.visualstudio.com/docs/devcontainers/tutorial">Dev Containers tutorial</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-the-contracts"><a class="header" href="#build-the-contracts">Build the contracts</a></h1>
<p>Open a terminal and run the following command:</p>
<pre><code class="language-shell">scarb build
</code></pre>
<p>This will build the smart contracts into <code>target</code> directory.</p>
<p>Sample output:</p>
<pre><code class="language-shell">tree target/dev
target/dev
├── satoru.starknet_artifacts.json
├── satoru_DataStore.sierra.json
└── satoru_RoleStore.sierra.json
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="test-the-contracts"><a class="header" href="#test-the-contracts">Test the contracts</a></h1>
<p>Open a terminal and run the following command:</p>
<pre><code class="language-shell">snforge
</code></pre>
<p>This will execute the tests in <code>tests</code> directory and print the results.</p>
<p>Sample output:</p>
<pre><code class="language-shell">Collected 4 test(s) and 3 test file(s)
Running 0 test(s) from src/lib.cairo
Running 2 test(s) from tests/data/test_data_store.cairo
[PASS] test_data_store::test_data_store::test_get_and_set_felt252
[PASS] test_data_store::test_data_store::test_get_and_set_u256
Running 2 test(s) from tests/role/test_role_store.cairo
[PASS] test_role_store::test_role_store::test_grant_role
[PASS] test_role_store::test_role_store::test_revoke_role
Tests: 4 passed, 0 failed, 0 skipped
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="smart-contracts-architecture"><a class="header" href="#smart-contracts-architecture">Smart contracts architecture</a></h1>
<p>In this section, we will go through the smart contracts architecture.</p>
<p>Satoru is composed of several modules. Each module is a set of smart contracts and libraries that are related to a specific area.</p>
<p>The goal of this architecture is to make the code more readable and maintainable, as well as to make it easier to add new features.</p>
<p>Another goal is to enable composability. For example, the <code>Role</code> module can be used in any other module to add role-based access control to the module's functions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="protocol-overview"><a class="header" href="#protocol-overview">Protocol Overview</a></h1>
<p><img src="smart-contracts-architecture/../assets/satoru-diagram.png" alt="Schema" />
Satoru high-level modules overview.</p>
<h2 id="two-steps-actions-in-satoru"><a class="header" href="#two-steps-actions-in-satoru">Two steps actions in Satoru</a></h2>
<p>Satoru employs a two-step approach for critical actions like Deposit, Withdrawal, and Order execution. This method ensures enhanced security and guards against front-running risks.</p>
<p><img src="smart-contracts-architecture/../assets/satoru-two-steps.png" alt="TwoStepsActions" /></p>
<p>First user send its request and then it is verified and executed by a Keeper. This helps protect users from front-running issues.</p>
<p><strong>Process Overview:</strong></p>
<ol>
<li>
<p><strong>User Initiation:</strong> Users initiate actions by sending requests.</p>
</li>
<li>
<p><strong>Keeper Verification:</strong> A designated Keeper validates requests and executes actions on users' behalf.</p>
</li>
</ol>
<p>This approach safeguards against unauthorized actions and provides users with secure, reliable interactions within the system.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auto-deleveraging-adl-module"><a class="header" href="#auto-deleveraging-adl-module">Auto-Deleveraging (ADL) Module</a></h1>
<p>The ADL Module helps with automatic reduction of leverage in specific markets. This is particularly important for markets where the main token is different from the long token, like a STRK / USD perpetual market where ETH is the long token.</p>
<p>It contains the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/adl/adl_utils.cairo">adl.cairo</a></li>
</ul>
<h2 id="structures-and-types"><a class="header" href="#structures-and-types">Structures and Types</a></h2>
<h3 id="createadlorderparams"><a class="header" href="#createadlorderparams"><code>CreateAdlOrderParams</code></a></h3>
<p>This struct is utilized within the <code>create_adl_order</code> function to encapsulate parameters needed for the order creation, aiding in avoiding stack overflow.</p>
<ul>
<li><code>data_store</code>: The <code>DataStore</code> contract dispatcher which provides access to a centralized data storage, used for storing and retrieving information about markets, positions, orders, etc.</li>
<li><code>event_emitter</code>: The <code>EventEmitter</code> contract dispatcher utilized for emitting events on the blockchain, allowing users and other contracts to track changes in the system.</li>
<li><code>account</code>: The address of the account whose position is to be reduced. In the ADL context, this typically means closing profitable positions to maintain system solvency.</li>
<li><code>market</code>: Address of the concerned market. Each market may have its own parameters and states, and this address helps identify the specific market to be dealt with.</li>
<li><code>collateral_token</code>: The address of the token used as collateral for the position. For instance, it's ETH in a STRK/USD market as per the given example.</li>
<li><code>is_long</code>: Indicates whether the position is long or short. A long position benefits from a price increase in the market, while a short position benefits from a price decrease.</li>
<li><code>size_delta_usd</code>: The size of the position to be reduced, expressed in US Dollars. This specifies how much of the position should be reduced to maintain system solvency.</li>
<li><code>updated_at_block</code>: The block number at which the order was updated. This tracks when the ADL order was last created or modified.</li>
</ul>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="update_adl_state"><a class="header" href="#update_adl_state"><code>update_adl_state</code></a></h3>
<p>Checks the pending profit state and updates an <code>isAdlEnabled</code> flag to avoid repeatedly validating whether auto-deleveraging is required. It uses an oracle to fetch market prices and emits an <code>adl_state_updated</code> event to notify about the state change. The function also updates the latest ADL block to the current block number to ensure that the ADL status is associated with the most recent data.</p>
<h3 id="create_adl_order"><a class="header" href="#create_adl_order"><code>create_adl_order</code></a></h3>
<p>Constructs an ADL order to reduce a profitable position. The function returns a <code>felt252</code> type representing the key of the created order, where <code>felt252</code> is a type representing a 252-bit field element.</p>
<h3 id="validate_adl"><a class="header" href="#validate_adl"><code>validate_adl</code></a></h3>
<p>Validates if the requested ADL can be executed by checking the ADL enabled state and ensuring the oracle block numbers are recent enough.</p>
<h3 id="get_latest_adl_block-set_latest_adl_block"><a class="header" href="#get_latest_adl_block-set_latest_adl_block"><code>get_latest_adl_block</code>, <code>set_latest_adl_block</code></a></h3>
<p>These functions interact with the <code>data_store</code> to retrieve and update the latest ADL block number respectively. <code>get_latest_adl_block</code> returns the latest block number at which the ADL flag was updated, and <code>set_latest_adl_block</code> sets the latest block number to a new value.</p>
<h3 id="get_adl_enabled-set_adl_enabled"><a class="header" href="#get_adl_enabled-set_adl_enabled"><code>get_adl_enabled</code>, <code>set_adl_enabled</code></a></h3>
<p>Interact with the <code>data_store</code> to get and set the ADL enabled state for a specified market and position type (long/short).</p>
<h3 id="emit_adl_state_updated"><a class="header" href="#emit_adl_state_updated"><code>emit_adl_state_updated</code></a></h3>
<p>Emits ADL state update events to notify about changes in the ADL state, including the market, position type, PnL to pool factor, max PnL factor, and whether ADL was enabled or disabled.</p>
<h2 id="errors"><a class="header" href="#errors">Errors</a></h2>
<p>The module defines an <code>AdlError</code> to handle ADL-specific errors. Each constant in the <code>AdlError</code> module represents a specific error case in the ADL module. Here are the defined errors:</p>
<ul>
<li>
<p><code>ORACLE_BLOCK_NUMBERS_ARE_SMALLER_THAN_REQUIRED</code>: This error is thrown when the block numbers from the oracle are smaller than required. It ensures that the data being used is recent enough to be reliable.</p>
</li>
<li>
<p><code>INVALID_SIZE_DELTA_FOR_ADL</code>: Triggered when the size of the position to be reduced is invalid, for example, if it's larger than the current position size. It ensures that the ADL order size is valid and can be executed.</p>
</li>
<li>
<p><code>ADL_NOT_ENABLED</code>: This error occurs if an ADL operation is attempted when ADL is not enabled for the specified market. It serves as a guard to prevent unwanted ADL operations.</p>
</li>
<li>
<p><code>POSITION_NOT_VALID</code>: Thrown when a position is not valid, for instance, if it doesn't exist or has already been closed. This error ensures that the position associated with the ADL order is valid and open.</p>
</li>
</ul>
<h3 id="others"><a class="header" href="#others">Others</a></h3>
<ul>
<li>Additional utility modules are imported for array operations, error handling, and callback utilities to support various functionalities within the ADL module.</li>
</ul>
<h2 id="usage-example"><a class="header" href="#usage-example">Usage Example</a></h2>
<pre><code class="language-cairo">// Example of creating an ADL order
let params = adl_utils::CreateAdlOrderParams {
    data_store: /* ... */,
    event_emitter: /* ... */,
    account: /* ... */,
    market: /* ... */,
    collateral_token: /* ... */,
    is_long: /* ... */,
    size_delta_usd: /* ... */,
    updated_at_block: /* ... */,
};
adl_utils::create_adl_order(params);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bank-module-token-handling"><a class="header" href="#bank-module-token-handling">Bank Module (Token Handling)</a></h1>
<p>This module helps to store and move tokens within a contract. It's crucial for a bigger project, letting you do basic bank tasks like starting the contract and sending tokens to a receiver.</p>
<p>It contains the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/bank/bank.cairo">bank.cairo</a></li>
</ul>
<h2 id="structures"><a class="header" href="#structures">Structures</a></h2>
<h3 id="storage"><a class="header" href="#storage"><code>Storage</code></a></h3>
<p>This struct houses the interface to interact with the <code>DataStore</code> contract, which is essential for the storage of data within the contract.</p>
<ul>
<li><code>data_store</code>: An instance of <code>IDataStoreDispatcher</code> providing the necessary methods to interact with the <code>DataStore</code> contract.</li>
</ul>
<h2 id="interface"><a class="header" href="#interface">Interface</a></h2>
<h3 id="ibanktcontractstate"><a class="header" href="#ibanktcontractstate"><code>IBank&lt;TContractState&gt;</code></a></h3>
<p>This interface defines the contract's structure and methods. The generic <code>TContractState</code> allows for a flexible contract state definition.</p>
<ul>
<li><code>initialize</code>: This method sets up the contract with the necessary addresses for the data store and role store contracts.</li>
<li><code>transfer_out</code>: A method to facilitate the transfer of tokens from this contract to a specified receiver.</li>
</ul>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<h3 id="bank-module"><a class="header" href="#bank-module"><code>Bank</code> Module</a></h3>
<p>This module provides the implementation for the <code>IBank</code> interface and additional helper methods necessary for the contract's functionality.</p>
<h4 id="constructor"><a class="header" href="#constructor"><code>constructor</code></a></h4>
<p>This is the constructor method for the contract, which calls the <code>initialize</code> method to set up the contract's state.</p>
<h4 id="bankimpl-of-ibankcontractstate"><a class="header" href="#bankimpl-of-ibankcontractstate"><code>BankImpl</code> of <code>IBank&lt;ContractState&gt;</code></a></h4>
<p>This implementation provides the methods defined in the <code>IBank</code> interface.</p>
<ul>
<li><code>initialize</code>: Ensures the contract is not already initialized, sets up the role module, and writes the data store address to the contract's state.</li>
<li><code>transfer_out</code>: Ensures the caller is a controller before proceeding to call the internal method for token transfer.</li>
</ul>
<h4 id="bankhelperimpl-of-bankhelpertrait"><a class="header" href="#bankhelperimpl-of-bankhelpertrait"><code>BankHelperImpl</code> of <code>BankHelperTrait</code></a></h4>
<p>This implementation provides additional helper methods for the contract.</p>
<ul>
<li><code>transfer_out_internal</code>: Checks that the receiver is not this contract itself, then performs the token transfer using the <code>transfer</code> method from <code>token_utils</code>.</li>
</ul>
<h2 id="strictbank-module"><a class="header" href="#strictbank-module">StrictBank Module</a></h2>
<p>The StrictBank module extends the functionalities of the Bank module by implementing a sync function to update token balances, which can be particularly useful in scenarios of token burns or similar balance changes.</p>
<h3 id="interface-1"><a class="header" href="#interface-1">Interface</a></h3>
<h4 id="istrictbanktcontractstate"><a class="header" href="#istrictbanktcontractstate"><code>IStrictBank&lt;TContractState&gt;</code></a></h4>
<p>This interface extends the <code>IBank</code> interface and includes an additional method for syncing token balances.</p>
<ul>
<li><code>sync_token_balance</code>: Updates the <code>token_balances</code> in case of token burns or similar balance changes. This function returns the new balance of the specified token.</li>
</ul>
<h3 id="implementation-1"><a class="header" href="#implementation-1">Implementation</a></h3>
<h4 id="strictbank-of-istrictbankcontractstate"><a class="header" href="#strictbank-of-istrictbankcontractstate"><code>StrictBank</code> of <code>IStrictBank&lt;ContractState&gt;</code></a></h4>
<p>This implementation provides the methods defined in the <code>IStrictBank</code> interface. It relies on the <code>Bank</code> module for <code>initialize</code> and <code>transfer_out</code> methods, while providing a custom implementation for <code>sync_token_balance</code> method which currently returns a placeholder value of <code>0</code>.</p>
<h2 id="errors-1"><a class="header" href="#errors-1">Errors</a></h2>
<h3 id="bankerror"><a class="header" href="#bankerror"><code>BankError</code></a></h3>
<p>This enum encapsulates the error definitions for this contract, ensuring that the contract's methods are used correctly and safely.</p>
<ul>
<li><code>ALREADY_INITIALIZED</code>: Thrown if an attempt is made to initialize the contract when it's already initialized. Error code: <code>'already_initialized'</code>.</li>
<li><code>SELF_TRANSFER_NOT_SUPPORTED</code>: Thrown if an attempt is made to transfer tokens to the contract itself. Error code: <code>'self_transfer_not_supported'</code>.</li>
<li><code>TOKEN_TRANSFER_FAILED</code>: Thrown if a token transfer operation fails. Error code: <code>'token_transfer_failed'</code>.</li>
</ul>
<h2 id="usage-example-1"><a class="header" href="#usage-example-1">Usage Example</a></h2>
<p>Here's a simplified example demonstrating how to initialize and interact with the <code>Bank</code> contract in Cairo:</p>
<pre><code class="language-cairo">use starknet::{ContractAddress, contract_address_const};
use satoru::bank::bank::{IBankDispatcherTrait, IBankDispatcher};

// Deploying the Bank contract
let bank_contract = declare('Bank');
let constructor_calldata = array![data_store_contract_address.into(), role_store_contract_address.into()];
let bank_contract_address = bank_contract.deploy(@constructor_calldata).unwrap();
let bank_dispatcher = IBankDispatcher { contract_address: bank_contract_address };

// Transferring tokens using the Bank contract
let receiver_address: ContractAddress = 0x202.try_into().unwrap();
bank_dispatcher.transfer_out(erc20_contract_address, receiver_address, 100_u128);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="callback-module"><a class="header" href="#callback-module">Callback Module</a></h2>
<p>The Callback module is a part of the Satoru project and manages a two-step process. First, a user sends a request, then a keeper sends another transaction to carry out that request. This module makes it easier to work with other contracts by letting a special contract be specified, which gets called after requests are done or cancelled.</p>
<p>This module contains the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/tree/main/src/callback">callback</a></li>
</ul>
<h2 id="functions-1"><a class="header" href="#functions-1">Functions</a></h2>
<h3 id="validate_callback_gas_limit"><a class="header" href="#validate_callback_gas_limit"><code>validate_callback_gas_limit</code></a></h3>
<p>Validates that the specified <code>callback_gas_limit</code> is below a maximum specified value to prevent callback gas limits exceeding the max gas limits per block.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>data_store</code>: The data store to use.</li>
<li><code>callback_gas_limit</code>: The callback gas limit.</li>
</ul>
</li>
</ul>
<h3 id="set_saved_callback_contract"><a class="header" href="#set_saved_callback_contract"><code>set_saved_callback_contract</code></a></h3>
<p>Allows an external entity to associate a callback contract address with a specific account and market.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>data_store</code>: The <code>DataStore</code> contract dispatcher.</li>
<li><code>account</code>: The account to set callback contract for.</li>
<li><code>market</code>: The market to set callback contract for.</li>
<li><code>callback_contract</code>: The callback contract address.</li>
</ul>
</li>
</ul>
<h3 id="get_saved_callback_contract"><a class="header" href="#get_saved_callback_contract"><code>get_saved_callback_contract</code></a></h3>
<p>Retrieves a previously stored callback contract address associated with a given account and market from the data store.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>data_store</code>: The <code>DataStore</code> contract dispatcher.</li>
<li><code>account</code>: The account to get callback contract for.</li>
<li><code>market</code>: The market to get callback contract for.</li>
</ul>
</li>
</ul>
<h3 id="function_after_deposit_execution-function_after_deposit_cancellation-function_after_withdrawal_execution-function_after_withdrawal_cancellation-function_after_order_execution-function_after_order_cancellation-and-function_after_order_frozen"><a class="header" href="#function_after_deposit_execution-function_after_deposit_cancellation-function_after_withdrawal_execution-function_after_withdrawal_cancellation-function_after_order_execution-function_after_order_cancellation-and-function_after_order_frozen">function_after_deposit_execution, function_after_deposit_cancellation, function_after_withdrawal_execution, function_after_withdrawal_cancellation, function_after_order_execution, function_after_order_cancellation, and function_after_order_frozen</a></h3>
<p>These functions are callback handlers called after specific actions such as deposit execution, deposit cancellation, withdrawal execution, withdrawal cancellation, order execution, order cancellation, and order frozen respectively.</p>
<p>These functions are callback handlers called after specific actions such as deposit execution, deposit cancellation, withdrawal execution, withdrawal cancellation, order execution, order cancellation, and order frozen respectively.</p>
<ul>
<li><strong>Common Arguments:</strong>
<ul>
<li><code>key</code>: The key of the order/deposit/withdrawal.</li>
<li><code>order</code>/<code>deposit</code>/<code>withdrawal</code>: The order/deposit/withdrawal that was executed/cancelled/frozen.</li>
<li><code>event_data</code>: The event log data.</li>
<li><code>event_emitter</code>: The event emitter dispatcher.</li>
</ul>
</li>
</ul>
<h3 id="is_valid_callback_contract"><a class="header" href="#is_valid_callback_contract"><code>is_valid_callback_contract</code></a></h3>
<p>Validates that the given address is a contract.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>callback_contract</code>: The callback contract.</li>
</ul>
</li>
</ul>
<h2 id="errors-2"><a class="header" href="#errors-2">Errors</a></h2>
<h3 id="callbackerror"><a class="header" href="#callbackerror"><code>CallbackError</code></a></h3>
<p>This enum encapsulates the error definitions for this module, ensuring that the contract's methods are used correctly and safely.</p>
<ul>
<li><code>MAX_CALLBACK_GAS_LIMIT_EXCEEDED</code>: Thrown when the <code>callback_gas_limit</code> exceeds the maximum specified value. Error code: <code>'max_callback_gas_limit_exceeded'</code>.</li>
</ul>
<h2 id="interface-for-depositcallbackreceiver"><a class="header" href="#interface-for-depositcallbackreceiver">Interface for <code>DepositCallbackReceiver</code></a></h2>
<p>The <code>DepositCallbackReceiver</code> interface defines the callback handlers that are triggered after a deposit operation such as execution or cancellation. This interface is crucial for the callback mechanism within the Satoru project, allowing for additional logic to be executed after a deposit operation.</p>
<h3 id="idepositcallbackreceivertcontractstate"><a class="header" href="#idepositcallbackreceivertcontractstate"><code>IDepositCallbackReceiver&lt;TContractState&gt;</code></a></h3>
<p>This interface specifies the methods for handling callbacks after deposit operations.</p>
<h4 id="after_deposit_execution"><a class="header" href="#after_deposit_execution"><code>after_deposit_execution</code></a></h4>
<p>Called after a deposit execution.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>self</code>: The contract state.</li>
<li><code>key</code>: The key of the deposit.</li>
<li><code>deposit</code>: The deposit that was executed.</li>
<li><code>event_data</code>: The event log data.</li>
</ul>
</li>
</ul>
<h4 id="after_deposit_cancellation"><a class="header" href="#after_deposit_cancellation"><code>after_deposit_cancellation</code></a></h4>
<p>Called after a deposit cancellation.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>self</code>: The contract state.</li>
<li><code>key</code>: The key of the deposit.</li>
<li><code>deposit</code>: The deposit that was cancelled.</li>
<li><code>event_data</code>: The event log data.</li>
</ul>
</li>
</ul>
<h2 id="interface-for-ordercallbackreceiver"><a class="header" href="#interface-for-ordercallbackreceiver">Interface for <code>OrderCallbackReceiver</code></a></h2>
<p>The <code>OrderCallbackReceiver</code> interface defines the callback handlers that are triggered after an order operation such as execution, cancellation, or being frozen. This interface is vital for the callback mechanism within the Satoru project, allowing for additional logic to be executed after an order operation.</p>
<h3 id="iordercallbackreceivertcontractstate"><a class="header" href="#iordercallbackreceivertcontractstate"><code>IOrderCallbackReceiver&lt;TContractState&gt;</code></a></h3>
<p>This interface specifies the methods for handling callbacks after order operations.</p>
<h4 id="after_order_execution"><a class="header" href="#after_order_execution"><code>after_order_execution</code></a></h4>
<p>Called after an order execution.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>self</code>: The contract state.</li>
<li><code>key</code>: The key of the order.</li>
<li><code>order</code>: The order that was executed.</li>
<li><code>event_data</code>: The event log data.</li>
</ul>
</li>
</ul>
<h4 id="after_order_cancellation"><a class="header" href="#after_order_cancellation"><code>after_order_cancellation</code></a></h4>
<p>Called after an order cancellation.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>self</code>: The contract state.</li>
<li><code>key</code>: The key of the order.</li>
<li><code>order</code>: The order that was cancelled.</li>
<li><code>event_data</code>: The event log data.</li>
</ul>
</li>
</ul>
<h4 id="after_order_frozen"><a class="header" href="#after_order_frozen"><code>after_order_frozen</code></a></h4>
<p>Called after an order is frozen.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>self</code>: The contract state.</li>
<li><code>key</code>: The key of the order.</li>
<li><code>order</code>: The order that was frozen.</li>
<li><code>event_data</code>: The event log data.</li>
</ul>
</li>
</ul>
<h2 id="interface-for-withdrawalcallbackreceiver"><a class="header" href="#interface-for-withdrawalcallbackreceiver">Interface for <code>WithdrawalCallbackReceiver</code></a></h2>
<p>The <code>WithdrawalCallbackReceiver</code> interface defines the callback handlers that are triggered after a withdrawal operation such as execution or cancellation. This interface is crucial for the callback mechanism within the Satoru project, allowing for additional logic to be executed after a withdrawal operation.</p>
<h3 id="iwithdrawalcallbackreceivertcontractstate"><a class="header" href="#iwithdrawalcallbackreceivertcontractstate"><code>IWithdrawalCallbackReceiver&lt;TContractState&gt;</code></a></h3>
<p>This interface specifies the methods for handling callbacks after withdrawal operations.</p>
<h4 id="after_withdrawal_execution"><a class="header" href="#after_withdrawal_execution"><code>after_withdrawal_execution</code></a></h4>
<p>Called after a withdrawal execution.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>self</code>: The contract state.</li>
<li><code>key</code>: The key of the withdrawal.</li>
<li><code>withdrawal</code>: The withdrawal that was executed.</li>
<li><code>event_data</code>: The event log data.</li>
</ul>
</li>
</ul>
<h4 id="after_withdrawal_cancellation"><a class="header" href="#after_withdrawal_cancellation"><code>after_withdrawal_cancellation</code></a></h4>
<p>Called after a withdrawal cancellation.</p>
<ul>
<li><strong>Arguments:</strong>
<ul>
<li><code>self</code>: The contract state.</li>
<li><code>key</code>: The key of the withdrawal.</li>
<li><code>withdrawal</code>: The withdrawal that was cancelled.</li>
<li><code>event_data</code>: The event log data.</li>
</ul>
</li>
</ul>
<h2 id="usage-example-2"><a class="header" href="#usage-example-2">Usage Example</a></h2>
<pre><code class="language-cairo">use starknet::ContractAddress;
use satoru::callback::callback;
use satoru::data::data_store::{IDataStoreDispatcher, IDataStoreDispatcherTrait};

// Assuming data_store, account, market, and callback_contract are already initialized
callback::set_saved_callback_contract(data_store, account, market, callback_contract);

// Retrieving the saved callback contract
let saved_callback_contract = callback::get_saved_callback_contract(data_store, account, market);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="chain-module"><a class="header" href="#chain-module">Chain Module</a></h2>
<p>The Chain module provides functionalities to query chain-specific variables. It is designed as a library contract for retrieving the current block number and timestamp.</p>
<p>This module contains the following Cairo library file:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/chain/chain.cairo">chain.cairo</a></li>
</ul>
<h2 id="functions-2"><a class="header" href="#functions-2">Functions</a></h2>
<h3 id="get_block_number"><a class="header" href="#get_block_number"><code>get_block_number</code></a></h3>
<p>Returns the current block number on the Starknet network.</p>
<ul>
<li>
<p><strong>Arguments:</strong> None.</p>
</li>
<li>
<p><strong>Returns:</strong> <code>u64</code> - The current block number.</p>
</li>
</ul>
<h3 id="get_block_timestamp"><a class="header" href="#get_block_timestamp"><code>get_block_timestamp</code></a></h3>
<p>Returns the timestamp of the current block on the Starknet network.</p>
<ul>
<li>
<p><strong>Arguments:</strong> None.</p>
</li>
<li>
<p><strong>Returns:</strong> <code>u64</code> - The timestamp of the current block.</p>
</li>
</ul>
<h2 id="errors-3"><a class="header" href="#errors-3">Errors</a></h2>
<p>This module does not define any custom errors.</p>
<h2 id="interface-for-chain"><a class="header" href="#interface-for-chain">Interface for <code>Chain</code></a></h2>
<p>The <code>Chain</code> interface defines the methods to query chain-specific variables like block number and block timestamp. These methods are crucial for contracts that need to interact with or check chain data.</p>
<h3 id="ichaintcontractstate"><a class="header" href="#ichaintcontractstate"><code>IChain&lt;TContractState&gt;</code></a></h3>
<p>This interface specifies the methods for querying chain-specific variables.</p>
<h4 id="get_block_number-1"><a class="header" href="#get_block_number-1"><code>get_block_number</code></a></h4>
<p>Called to retrieve the current block number.</p>
<ul>
<li>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>self</code>: The contract state.</li>
</ul>
</li>
<li>
<p><strong>Returns:</strong> <code>u64</code> - The current block number.</p>
</li>
</ul>
<h4 id="get_block_timestamp-1"><a class="header" href="#get_block_timestamp-1"><code>get_block_timestamp</code></a></h4>
<p>Called to retrieve the timestamp of the current block.</p>
<ul>
<li>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>self</code>: The contract state.</li>
</ul>
</li>
<li>
<p><strong>Returns:</strong> <code>u64</code> - The timestamp of the current block.</p>
</li>
</ul>
<h2 id="usage-example-3"><a class="header" href="#usage-example-3">Usage Example</a></h2>
<pre><code class="language-cairo">TODO</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="config-module"><a class="header" href="#config-module">Config Module</a></h1>
<p>The Configuration Module is really important because it lets you manage different settings in the project. You can change and view configurations related to contracts, roles, gas limits, markets, and more. It makes sure everything works within set rules and is crucial for the system to operate properly.</p>
<p>Below is a detailed documentation of the Configuration Module, explaining its structures, types, functions, errors, imports, and a sample usage.</p>
<p>It contains the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/config/config.cairo">adl.cairo</a></li>
</ul>
<h2 id="additional-module-timelock"><a class="header" href="#additional-module-timelock">Additional Module: Timelock</a></h2>
<p>Within the system, there's a module named <code>Timelock</code> designed to handle functionalities related to time-lock mechanisms. This is crucial for operations that require a predefined time delay for execution, enhancing the security and control over critical operations.</p>
<h2 id="structures-and-types-1"><a class="header" href="#structures-and-types-1">Structures and Types</a></h2>
<h3 id="storage-1"><a class="header" href="#storage-1"><code>Storage</code></a></h3>
<p>This struct encapsulates the storage fields necessary for the Configuration module, providing interfaces to interact with other contracts and a map to manage allowed base keys.</p>
<ul>
<li><code>role_store</code>: An interface to interact with the <code>RoleStore</code> contract.</li>
<li><code>data_store</code>: An interface to interact with the <code>DataStore</code> contract.</li>
<li><code>event_emitter</code>: An interface to interact with the <code>EventEmitter</code> contract.</li>
<li><code>allowed_base_keys</code>: A map to manage the allowed base keys for setting configurations.</li>
</ul>
<h2 id="functions-3"><a class="header" href="#functions-3">Functions</a></h2>
<h3 id="constructor-1"><a class="header" href="#constructor-1"><code>constructor</code></a></h3>
<p>This function initializes the <code>Storage</code> struct with provided contract addresses and calls <code>init_allowed_base_keys</code> function to initialize allowed base keys.</p>
<h3 id="set_bool-set_address-set_felt252"><a class="header" href="#set_bool-set_address-set_felt252"><code>set_bool</code>, <code>set_address</code>, <code>set_felt252</code></a></h3>
<p>These functions are implementations of the <code>IConfig</code> interface, allowing setting configurations of different data types. They ensure the caller has the <code>CONFIG_KEEPER</code> role, validate the base key, compute the full key from the base key and additional data, and set the value in the <code>DataStore</code>.</p>
<h3 id="init_allowed_base_keys"><a class="header" href="#init_allowed_base_keys"><code>init_allowed_base_keys</code></a></h3>
<p>This function initializes the map of allowed base keys for setting configurations. It writes true to each base key that is allowed to be set.</p>
<h3 id="validate_key"><a class="header" href="#validate_key"><code>validate_key</code></a></h3>
<p>This function checks that a provided base key is in the list of allowed base keys, throwing <code>ConfigError::INVALID_BASE_KEY</code> if it's not.</p>
<h3 id="get_full_key"><a class="header" href="#get_full_key"><code>get_full_key</code></a></h3>
<p>This function computes the full key from the provided base key and additional data. If there's no additional data, it returns the base key. Otherwise, it computes a Poseidon hash of the concatenated base key and data.</p>
<h2 id="errors-4"><a class="header" href="#errors-4">Errors</a></h2>
<h3 id="configerror"><a class="header" href="#configerror"><code>ConfigError</code></a></h3>
<p>This module defines a <code>ConfigError</code> to handle configuration-specific errors. Here are the defined errors:</p>
<ul>
<li><code>INVALID_BASE_KEY</code>: This error is thrown when a base key provided is not in the list of allowed base keys. It is represented by the constant <code>'invalid_base_key'</code> in the <code>ConfigError</code> module.</li>
</ul>
<h2 id="usage-example-4"><a class="header" href="#usage-example-4">Usage Example</a></h2>
<pre><code class="language-cairo">// Example of setting a bool configuration
let base_key = /* ... */;
let data = array![];
let value = true;
Config::set_bool(contract_state, base_key, data, value);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="data-module"><a class="header" href="#data-module">Data Module</a></h2>
<p>The Data Module serves as the backbone for storing and managing the protocol's data. Below is a detailed outline of its constituents and their respective functions and responsibilities.</p>
<h3 id="smart-contracts"><a class="header" href="#smart-contracts">Smart Contracts</a></h3>
<h4 id="data_storecairo"><a class="header" href="#data_storecairo"><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/data/data_store.cairo">data_store.cairo</a></a></h4>
<p>The <code>DataStore</code> is the central smart contract of the module, holding the responsibility of maintaining the protocol's data. It manages different entities, including orders, positions, withdrawals, and deposits.</p>
<h5 id="key-features--responsibilities"><a class="header" href="#key-features--responsibilities">Key Features &amp; Responsibilities:</a></h5>
<ul>
<li>
<p><strong>Order Management:</strong> Enables the creation, reading, updating, and deletion of orders, each linked to a specific user account. Orders can be retrieved using their unique keys or can be listed per user account.</p>
</li>
<li>
<p><strong>Position Management:</strong> Manages financial positions associated with user accounts, offering functionalities to manipulate and view positions individually or by user account.</p>
</li>
<li>
<p><strong>Withdrawal Management:</strong> Supports the creation, reading, updating, and deletion of withdrawal requests, and enables the listing of withdrawals by user account.</p>
</li>
<li>
<p><strong>Deposit Management:</strong> Manages user deposits, allowing the creation, reading, updating, and deletion of deposits, viewable individually or listed by user account.</p>
</li>
<li>
<p><strong>Market Management:</strong> Facilitates the addition, deletion, and retrieval of markets, managing market indexes and ensuring that only authorized users can perform these operations.</p>
</li>
<li>
<p><strong>Oracle Functions:</strong> Allows setting and getting token IDs, with stringent access controls, ensuring only authorized entities can access them.</p>
</li>
<li>
<p><strong>Access Control and Security:</strong> Implements rigorous access control mechanisms, ensuring that only authorized addresses can perform certain operations. Specific role controls are applied, allowing only addresses with the <code>CONTROLLER</code> role to perform sensitive modifications to the contract’s state.</p>
</li>
</ul>
<h5 id="constructor-2"><a class="header" href="#constructor-2">Constructor</a></h5>
<p>The constructor initializes the contract with a <code>role_store</code> address, establishing the access control and role management mechanism from the deployment of the contract.</p>
<h3 id="cairo-library-files"><a class="header" href="#cairo-library-files">Cairo Library Files</a></h3>
<h4 id="keyscairo"><a class="header" href="#keyscairo"><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/data/keys.cairo">keys.cairo</a></a></h4>
<p>This Cairo library file plays a crucial role in generating the keys for the protocol's entries in the data store. The keys serve as unique identifiers, enabling the protocol to accurately access and manage the stored data.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deposit-module"><a class="header" href="#deposit-module">Deposit Module</a></h1>
<p>The deposit module contains main Satoru functions for deposit, to manage the depositing of liquidity into a market.</p>
<p>It contains the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/deposit/deposit_utils.cairo">deposit_utils.cairo</a>: Library for deposit functions, to help with the depositing of liquidity into a market in return for market tokens.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/deposit/deposit.cairo">deposit.cairo</a>: Contains Deposit struct.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/deposit/execute_deposit_utils.cairo">execute_deposit_utils.cairo</a>: Library for deposit functions, to help with the depositing of liquidity into a market in return for market tokens.</li>
</ul>
<h2 id="structures-and-types-2"><a class="header" href="#structures-and-types-2">Structures and Types</a></h2>
<h3 id="createdepositparams"><a class="header" href="#createdepositparams"><code>CreateDepositParams</code></a></h3>
<p>This struct is utilized within the <code>create_deposit</code> function to encapsulate parameters needed for the deposit creation.</p>
<ul>
<li><code>receiver</code>: The address to send the market tokens to.</li>
<li><code>callback_contract</code>: The callback contract linked to this deposit.</li>
<li><code>ui_fee_receiver</code>: The UI fee receiver.</li>
<li><code>market</code>: The market to deposit into.</li>
<li><code>initial_long_token</code>: The initial long token address.</li>
<li><code>initial_short_token</code>: The initial short token address.</li>
<li><code>long_token_swap_path</code>: The swap path into markets for the long token.</li>
<li><code>short_token_swap_path</code>: The swap path into markets for the short token.</li>
<li><code>min_market_tokens</code>: The minimum acceptable number of liquidity tokens.</li>
<li><code>execution_fee</code>: The execution fee for keepers.</li>
<li><code>callback_gas_limit</code>: The gas limit for the <code>callback_contract</code>.</li>
</ul>
<h3 id="deposit"><a class="header" href="#deposit"><code>Deposit</code></a></h3>
<p>A structure to represent a deposit in the system, containing information such as the addresses of the tokens, amounts deposited, and parameters of the concerned market.</p>
<h3 id="depositerror"><a class="header" href="#depositerror"><code>DepositError</code></a></h3>
<p>Module for deposit-specific error operations.</p>
<ul>
<li><code>DEPOSIT_NOT_FOUND</code>: Deposit not found.</li>
<li><code>DEPOSIT_INDEX_NOT_FOUND</code>: Deposit index not found.</li>
<li><code>CANT_BE_ZERO</code>: Can't be zero.</li>
<li><code>EMPTY_DEPOSIT_AMOUNTS</code>: Empty deposit amounts.</li>
<li><code>EMPTY_DEPOSIT</code>: Empty deposit.</li>
</ul>
<h2 id="functions-4"><a class="header" href="#functions-4">Functions</a></h2>
<h3 id="create_deposit"><a class="header" href="#create_deposit"><code>create_deposit</code></a></h3>
<p>Creates a deposit with the specified parameters, recording the transfer of initial tokens and validating the swap paths.</p>
<h3 id="cancel_deposit"><a class="header" href="#cancel_deposit"><code>cancel_deposit</code></a></h3>
<p>Cancels a deposit, funds are sent back to the user.</p>
<h3 id="execute_deposit"><a class="header" href="#execute_deposit"><code>execute_deposit</code></a></h3>
<p>Executes a deposit according to the provided parameters. (Function to be developed)</p>
<h3 id="swap"><a class="header" href="#swap"><code>swap</code></a></h3>
<p>Performs a token swap according to the provided parameters. (Function to be developed)</p>
<h2 id="contracts"><a class="header" href="#contracts">Contracts</a></h2>
<h3 id="depositvault"><a class="header" href="#depositvault"><code>DepositVault</code></a></h3>
<p>The <code>DepositVault</code> contract provides functions to initialize the contract, transfer tokens out of the contract, and record a token transfer into the contract.</p>
<h2 id="usage-example-5"><a class="header" href="#usage-example-5">Usage Example</a></h2>
<pre><code class="language-cairo">// Example of creating a deposit
let params = CreateDepositParams {
    receiver: /* ... */,
    callback_contract: /* ... */,
    ui_fee_receiver: /* ... */,
    market: /* ... */,
    initial_long_token: /* ... */,
    initial_short_token: /* ... */,
    long_token_swap_path: /* ... */,
    short_token_swap_path: /* ... */,
    min_market_tokens: /* ... */,
    execution_fee: /* ... */,
    callback_gas_limit: /* ... */,
};

let key = create_deposit(
    data_store,
    event_emitter,
    deposit_vault,
    account,
    params
);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exchange-module"><a class="header" href="#exchange-module">Exchange Module</a></h1>
<p>The Exchange module contains the core functionalities of the Satoru protocol, handling the creation, execution, and cancellation of various actions.</p>
<h2 id="smart-contracts-1"><a class="header" href="#smart-contracts-1">Smart Contracts</a></h2>
<p>The module comprises the following smart contracts:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/exchange/adl_handler.cairo">AdlHandler</a>: This contract manages the ADL (Automatic Deleveraging) process.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/exchange/base_order_handler.cairo">BaseOrderHandler</a>: A base contract encapsulating shared functionalities for order handling.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/exchange/deposit_handler.cairo">DepositHandler</a>: Manages the creation, execution, and cancellation of deposit requests.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/exchange/liquidation_handler.cairo">LiquidationHandler</a>: Handles the liquidation process.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/exchange/order_handler.cairo">OrderHandler</a>: Manages the creation, execution, and cancellation of orders.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/exchange/withdrawal_handler.cairo">WithdrawalHandler</a>: Handles the creation, execution, and cancellation of withdrawal requests.</li>
</ul>
<h2 id="libraries"><a class="header" href="#libraries">Libraries</a></h2>
<p>The module also includes the following library files for utility and error handling:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/exchange/error.cairo">error.cairo</a>: Contains the module's error codes encapsulated as <code>ExchangeError</code>.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/exchange/withdrawal_event_utils.cairo">exchange_utils.cairo</a>: Provides request validation utility functions.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="feature-module"><a class="header" href="#feature-module">Feature Module</a></h1>
<p>The Feature Module checks if different parts of the system are turned on or off. It’s really important for keeping the system stable and working correctly.</p>
<p>It encompasses the following smart contracts:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/feature/feature_utils.cairo">feature_utils.cairo</a>: Central to the module, this contract is responsible for validating the operational status of a feature, determining whether it is enabled or disabled.</li>
</ul>
<h2 id="-warning"><a class="header" href="#-warning">⚠️ Warning</a></h2>
<p>Disabling a feature should be performed with extreme caution and only in absolutely necessary situations, as it can lead to unexpected and potentially harmful effects, such as operational discrepancies and system instability.</p>
<h2 id="functions-5"><a class="header" href="#functions-5">Functions</a></h2>
<h3 id="is_feature_disabled"><a class="header" href="#is_feature_disabled"><code>is_feature_disabled</code></a></h3>
<pre><code class="language-cairo">fn is_feature_disabled(data_store: IDataStoreDispatcher, key: felt252) -&gt; bool
</code></pre>
<ul>
<li><strong>Objective:</strong> Determines the operational status of a specified feature.</li>
<li><strong>Parameters:</strong>
<ul>
<li><code>data_store</code>: The data storage contract dispatcher, facilitating interaction with stored data.</li>
<li><code>key</code>: The feature key representing the specific feature in question.</li>
</ul>
</li>
<li><strong>Returns:</strong> A boolean indicating whether the feature is disabled.</li>
</ul>
<h3 id="validate_feature"><a class="header" href="#validate_feature"><code>validate_feature</code></a></h3>
<pre><code class="language-cairo">fn validate_feature(data_store: IDataStoreDispatcher, key: felt252)
</code></pre>
<ul>
<li><strong>Objective:</strong> Validates the operational status of a specified feature and reverts the operation if the feature is disabled.</li>
<li><strong>Parameters:</strong>
<ul>
<li><code>data_store</code>: The data storage contract dispatcher.</li>
<li><code>key</code>: The feature key representing the specific feature in question.</li>
</ul>
</li>
<li><strong>Implications:</strong> Essential for maintaining system integrity by halting operations related to disabled features.</li>
</ul>
<h2 id="errors-5"><a class="header" href="#errors-5">Errors</a></h2>
<h3 id="featureerror"><a class="header" href="#featureerror"><code>FeatureError</code></a></h3>
<ul>
<li><strong>DISABLED_FEATURE:</strong> This error is triggered when an attempt is made to operate a disabled feature, indicating a breach in feature utilization protocols.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fee-module"><a class="header" href="#fee-module">Fee Module</a></h1>
<p>The Fee Module takes care of everything related to fees. It’s crucial for moving and claiming fees in specific markets.</p>
<p>The module incorporates the following components:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/fee/fee_handler.cairo">FeeHandler.cairo</a>: The nucleus of the module, entrusted with initializing the contract and claiming fees from identified markets.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/fee/fee_utils.cairo">fee_utils.cairo</a>: A collection of utility functions vital for orchestrating fee actions and interactions such as claiming and incrementing fees.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/fee/error.cairo">error.cairo</a>: A repository of error codes and messages related to fee operations, essential for accurate error handling and resolution.</li>
</ul>
<h2 id="structures-and-types-3"><a class="header" href="#structures-and-types-3">Structures and Types</a></h2>
<h3 id="feehandler"><a class="header" href="#feehandler"><code>FeeHandler</code></a></h3>
<p>The <code>FeeHandler</code> struct is pivotal within the module, managing the interactions and executions of fee-related functions, ensuring the integrity of fee transfers and claims.</p>
<ul>
<li><code>data_store</code>: The <code>DataStore</code> contract dispatcher, a centralized repository for data storage, crucial for retrieving and storing information related to markets, positions, orders, etc.</li>
<li><code>role_store</code>: The <code>RoleStore</code> contract dispatcher, responsible for managing roles and permissions within the system.</li>
<li><code>event_emitter</code>: The <code>EventEmitter</code> contract dispatcher, vital for emitting events and notifications within the blockchain, allowing the tracking of system alterations.</li>
</ul>
<h2 id="functions-6"><a class="header" href="#functions-6">Functions</a></h2>
<h3 id="initialize"><a class="header" href="#initialize"><code>initialize</code></a></h3>
<ul>
<li><strong>Objective:</strong> Initialize the FeeHandler contract with essential components like <code>DataStore</code>, <code>RoleStore</code>, and <code>EventEmitter</code>.</li>
</ul>
<h3 id="claim_fees"><a class="header" href="#claim_fees"><code>claim_fees</code></a></h3>
<ul>
<li><strong>Objective:</strong> Execute fee claims from specified markets for given tokens.</li>
</ul>
<h2 id="error-handling"><a class="header" href="#error-handling">Error Handling</a></h2>
<h3 id="feeerror"><a class="header" href="#feeerror"><code>FeeError</code></a></h3>
<ul>
<li><strong>ALREADY_INITIALIZED:</strong> Triggered when there is an attempt to initialize an already initialized contract.</li>
<li><strong>INVALID_CLAIM_FEES_INPUT:</strong> Occurs when the lengths of the market and tokens arrays do not match during a fee claim operation.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gas-module"><a class="header" href="#gas-module">Gas Module</a></h1>
<p>The Gas Module is developed to manage execution fee estimations and payments within the system.</p>
<p>This module comprises the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/gas/gas_utils.cairo">GasUtils.cairo</a>: Entrusted with the responsibility for execution fee estimation and payments.</li>
</ul>
<h2 id="structures-and-types-4"><a class="header" href="#structures-and-types-4">Structures and Types</a></h2>
<h3 id="contractaddress"><a class="header" href="#contractaddress"><code>ContractAddress</code></a></h3>
<ul>
<li>A specialized type representing the address of a contract within the Starknet network.</li>
</ul>
<h2 id="functions-7"><a class="header" href="#functions-7">Functions</a></h2>
<h3 id="get_min_handle_execution_error_gas"><a class="header" href="#get_min_handle_execution_error_gas"><code>get_min_handle_execution_error_gas</code></a></h3>
<ul>
<li><strong>Objective:</strong> Retrieve the minimal gas required to handle execution errors from the data store.</li>
</ul>
<h3 id="get_execution_gas"><a class="header" href="#get_execution_gas"><code>get_execution_gas</code></a></h3>
<ul>
<li><strong>Objective:</strong> Validate that the starting gas is higher than the minimum handle execution gas and return the remaining gas after subtracting the minimum handle error gas.</li>
</ul>
<h3 id="pay_execution_fee"><a class="header" href="#pay_execution_fee"><code>pay_execution_fee</code></a></h3>
<ul>
<li><strong>Objective:</strong> Pays the execution fee to the keeper and refunds any excess amount to the refund receiver.</li>
</ul>
<h3 id="validate_execution_fee"><a class="header" href="#validate_execution_fee"><code>validate_execution_fee</code></a></h3>
<ul>
<li><strong>Objective:</strong> Validate that the provided execution fee is sufficient based on the estimated gas limit.</li>
</ul>
<h3 id="adjust_gas_usage"><a class="header" href="#adjust_gas_usage"><code>adjust_gas_usage</code></a></h3>
<ul>
<li><strong>Objective:</strong> Adjust the gas usage to ensure keepers are paid a nominal amount.</li>
</ul>
<h3 id="adjust_gas_limit_for_estimate"><a class="header" href="#adjust_gas_limit_for_estimate"><code>adjust_gas_limit_for_estimate</code></a></h3>
<ul>
<li><strong>Objective:</strong> Adjust the estimated gas limit to ensure the execution fee is sufficient during the actual execution.</li>
</ul>
<h3 id="estimate_execute_deposit_gas_limit-estimate_execute_withdrawal_gas_limit-estimate_execute_order_gas_limit"><a class="header" href="#estimate_execute_deposit_gas_limit-estimate_execute_withdrawal_gas_limit-estimate_execute_order_gas_limit"><code>estimate_execute_deposit_gas_limit</code>, <code>estimate_execute_withdrawal_gas_limit</code>, <code>estimate_execute_order_gas_limit</code></a></h3>
<ul>
<li><strong>Objective:</strong> Estimate the gas limits for deposits, withdrawals, and orders respectively based on different parameters.</li>
</ul>
<h3 id="pay_execution_fee_deposit"><a class="header" href="#pay_execution_fee_deposit"><code>pay_execution_fee_deposit</code></a></h3>
<ul>
<li><strong>Objective:</strong> Pay the deposit execution fee to the keeper and refund any excess amount to the refund receiver. It is specifically designed to handle deposit transactions.</li>
</ul>
<h3 id="estimate_execute_increase_order_gas_limit-estimate_execute_decrease_order_gas_limit-estimate_execute_swap_order_gas_limit"><a class="header" href="#estimate_execute_increase_order_gas_limit-estimate_execute_decrease_order_gas_limit-estimate_execute_swap_order_gas_limit"><code>estimate_execute_increase_order_gas_limit</code>, <code>estimate_execute_decrease_order_gas_limit</code>, <code>estimate_execute_swap_order_gas_limit</code></a></h3>
<ul>
<li><strong>Objective:</strong> Estimate the gas limits for increase orders, decrease orders, and swap orders respectively, based on different parameters.</li>
</ul>
<h2 id="errors-6"><a class="header" href="#errors-6">Errors</a></h2>
<h3 id="gaserror"><a class="header" href="#gaserror"><code>GasError</code></a></h3>
<ul>
<li><strong>INSUFF_EXEC_GAS (<code>'insufficient_gas_for_execute'</code>):</strong> Triggered when the starting gas is less than the minimum required to handle execution errors.</li>
<li><strong>INSUFF_EXEC_FEE (<code>'insufficient_execution_fee'</code>):</strong> Occurs when the provided execution fee is less than the minimum execution fee calculated based on the estimated gas limit.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="liquidation-module"><a class="header" href="#liquidation-module">Liquidation Module</a></h1>
<p>The Liquidation Module is designed to facilitate and manage liquidations within the system, ensuring stability and solvency of the market.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>This module contains the following Cairo library file:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/liquidation/liquidation_utils.cairo">liquidation_utils.cairo</a>: Entrusted with managing liquidations in the network.</li>
</ul>
<h2 id="structures-and-types-5"><a class="header" href="#structures-and-types-5">Structures and Types</a></h2>
<h3 id="createliquidationorderparams"><a class="header" href="#createliquidationorderparams"><code>CreateLiquidationOrderParams</code></a></h3>
<p>This struct is used within the <code>create_liquidation_order</code> function to encapsulate the necessary parameters for creating a liquidation order, thus preventing stack overflow.</p>
<ul>
<li><code>data_store</code>: The <code>DataStore</code> contract dispatcher providing access to centralized data storage, crucial for storing and retrieving market, position, and order-related information.</li>
<li><code>event_emitter</code>: The <code>EventEmitter</code> contract dispatcher, essential for emitting events on the blockchain and allowing users and other contracts to monitor system changes.</li>
<li><code>account</code>: Represents the address of the account associated with the position to be liquidated.</li>
<li><code>market</code>: Specifies the address of the concerned market, aiding in identifying the specific market parameters and states involved.</li>
<li><code>collateral_token</code>: Represents the address of the token used as collateral for the position, crucial for determining the liquidation impact.</li>
<li><code>is_long</code>: A boolean indicating whether the position is long or short, defining the nature of the liquidation.</li>
</ul>
<h2 id="functions-8"><a class="header" href="#functions-8">Functions</a></h2>
<h3 id="create_liquidation_order"><a class="header" href="#create_liquidation_order"><code>create_liquidation_order</code></a></h3>
<p>This function creates a liquidation order for a specific position, ensuring market stability and solvency. The function returns a <code>felt252</code> type representing the key of the created order, where <code>felt252</code> is a type representing a 252-bit field element.</p>
<h2 id="usage-example-6"><a class="header" href="#usage-example-6">Usage Example</a></h2>
<pre><code class="language-cairo">// Example of creating a liquidation order
let params = liquidation_utils::CreateLiquidationOrderParams {
    data_store: /* ... */,
    event_emitter: /* ... */,
    account: /* ... */,
    market: /* ... */,
    collateral_token: /* ... */,
    is_long: /* ... */,
};
liquidation_utils::create_liquidation_order(params);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="market-module"><a class="header" href="#market-module">Market Module</a></h1>
<p>The Market Module helps with trading in different markets. It lets you create markets by choosing specific tokens. This module supports both regular and ongoing trading.</p>
<p>Example markets include:</p>
<ul>
<li>ETH/USD: Long collateral as ETH, short collateral as a stablecoin, index token as ETH.</li>
<li>BTC/USD: Long collateral as WBTC, short collateral as a stablecoin, index token as BTC.</li>
<li>STRK/USD: Long collateral as ETH, short collateral as a stablecoin, index token as STRK.</li>
</ul>
<p>In each market, liquidity providers can deposit either the long or the short collateral token, or both, to mint liquidity tokens. The module allows for risk isolation by exposing liquidity providers only to the markets they deposit into, enabling potentially permissionless listings.</p>
<p>It contains the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/market/market.cairo">market.cairo</a> </li>
</ul>
<h2 id="structures-and-types-6"><a class="header" href="#structures-and-types-6">Structures and Types</a></h2>
<h3 id="market"><a class="header" href="#market"><code>Market</code></a></h3>
<p>This struct represents a market with the following fields:</p>
<ul>
<li><code>market_token</code>: Address of the market token for the market.</li>
<li><code>index_token</code>: Address of the index token for the market.</li>
<li><code>long_token</code>: Address of the long token for the market.</li>
<li><code>short_token</code>: Address of the short token for the market.</li>
</ul>
<h2 id="functions-and-traits"><a class="header" href="#functions-and-traits">Functions and Traits</a></h2>
<h3 id="intomarkettoken"><a class="header" href="#intomarkettoken"><code>IntoMarketToken</code></a></h3>
<p>This trait provides a method to get the <code>MarketToken</code> contract interface of a market.</p>
<h3 id="uniqueidmarket"><a class="header" href="#uniqueidmarket"><code>UniqueIdMarket</code></a></h3>
<p>This trait provides a method to compute the unique id of a market based on its parameters.</p>
<h3 id="validatemarket"><a class="header" href="#validatemarket"><code>ValidateMarket</code></a></h3>
<p>This trait provides methods to validate a market, either by returning a boolean value or by asserting the validity.</p>
<h2 id="implementations"><a class="header" href="#implementations">Implementations</a></h2>
<h3 id="uniqueidmarketimpl"><a class="header" href="#uniqueidmarketimpl"><code>UniqueIdMarketImpl</code></a></h3>
<p>This is the implementation of the <code>UniqueIdMarket</code> trait for the <code>Market</code> struct, providing a method to compute the unique id of a market.</p>
<h3 id="validatemarketimpl"><a class="header" href="#validatemarketimpl"><code>ValidateMarketImpl</code></a></h3>
<p>This is the implementation of the <code>ValidateMarket</code> trait for the <code>Market</code> struct, offering methods to validate the market's state.</p>
<h3 id="markettokenimpl"><a class="header" href="#markettokenimpl"><code>MarketTokenImpl</code></a></h3>
<p>This is the implementation of the <code>IntoMarketToken</code> trait for the <code>Market</code> struct, providing the <code>MarketToken</code> contract interface of a market.</p>
<h2 id="errors-7"><a class="header" href="#errors-7">Errors</a></h2>
<p>The module incorporates a <code>MarketError</code> enum to manage market-specific errors, primarily to handle cases involving invalid market parameters. Each constant in the <code>MarketError</code> module represents a specific error case in the market module. Here are the defined errors:</p>
<ul>
<li><strong><code>MARKET_NOT_FOUND</code></strong>: Triggered when the specified market cannot be located within the system.</li>
<li><strong><code>DIVISOR_CANNOT_BE_ZERO</code></strong>: Raised when an attempt is made to divide by zero.</li>
<li><strong><code>INVALID_MARKET_PARAMS</code></strong>: Occurs when the parameters provided for the market are invalid.</li>
<li><strong><code>OPEN_INTEREST_CANNOT_BE_UPDATED_FOR_SWAP_ONLY_MARKET</code></strong>: This error is triggered when there is an attempt to update open interest for a swap-only market.</li>
<li><strong><code>MAX_OPEN_INTEREST_EXCEEDED</code></strong>: Occurs when the maximum open interest for a market is surpassed.</li>
<li><strong><code>EMPTY_ADDRESS_IN_MARKET_TOKEN_BALANCE_VALIDATION</code></strong>: Raised when an empty address is found during market token balance validation.</li>
<li><strong><code>EMPTY_ADDRESS_TOKEN_BALANCE_VAL</code></strong>: Triggered when an empty address is discovered during token balance validation.</li>
<li><strong><code>INVALID_MARKET_TOKEN_BALANCE</code></strong>: Occurs when the market token balance is found to be invalid.</li>
<li><strong><code>INVALID_MARKET_TOKEN_BALANCE_FOR_COLLATERAL_AMOUNT</code></strong>: This error is raised when the market token balance for a collateral amount is invalid.</li>
<li><strong><code>INVALID_MARKET_TOKEN_BALANCE_FOR_CLAIMABLE_FUNDING</code></strong>: Triggered when the market token balance for claimable funding is invalid.</li>
<li><strong><code>EmptyAddressInMarketTokenBalanceValidation</code></strong>: Occurs when an empty address is encountered during market token balance validation.</li>
<li><strong><code>INVALID_POSITION_MARKET</code></strong>: Raised when the market for a position is invalid.</li>
<li><strong><code>INVALID_COLLATERAL_TOKEN_FOR_MARKET</code></strong>: Triggered when an invalid collateral token is provided for the market.</li>
<li><strong><code>EMPTY_MARKET</code></strong>: Occurs when the market is found to be empty.</li>
<li><strong><code>DISABLED_MARKET</code></strong>: Triggered when the market is disabled.</li>
</ul>
<p>Additionally, there is a function <code>UNABLE_TO_GET_CACHED_TOKEN_PRICE</code> which panics with a specific message when it is unable to get the cached token price for a given token.</p>
<h2 id="usage-example-7"><a class="header" href="#usage-example-7">Usage Example</a></h2>
<pre><code class="language-cairo">let market = Market {
    market_token: /* ContractAddress of the market token */,
    index_token: /* ContractAddress of the index token */,
    long_token: /* ContractAddress of the long token */,
    short_token: /* ContractAddress of the short token */,
};

// Asserting that the market is valid
market.assert_valid();
// Getting the MarketToken contract interface of the market
let market_token_dispatcher = market.market_token();</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mock-module"><a class="header" href="#mock-module">Mock Module</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nonce-module"><a class="header" href="#nonce-module">Nonce Module</a></h1>
<p>The Nonce Module keeps track of a number that goes up one at a time, which is crucial for creating unique keys. This is really important to make sure every operation in the system is unique.</p>
<p>It contains the following smart contract:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/nonce/nonce_utils.cairo">NonceUtils.cairo</a>: The principal smart contract in the module, responsible for sustaining an incrementing nonce value crucial for key generation.</li>
</ul>
<h2 id="structures-and-types-7"><a class="header" href="#structures-and-types-7">Structures and Types</a></h2>
<h3 id="idatastoredispatcher"><a class="header" href="#idatastoredispatcher"><code>IDataStoreDispatcher</code></a></h3>
<ul>
<li>The dispatcher for <code>DataStore</code> contract provides methods to interact with the centralized data storage, essential for storing and retrieving nonce-related information.</li>
</ul>
<h2 id="functions-9"><a class="header" href="#functions-9">Functions</a></h2>
<h3 id="get_current_nonce"><a class="header" href="#get_current_nonce"><code>get_current_nonce</code></a></h3>
<ul>
<li>Retrieves the current nonce value from the data store.</li>
<li><strong>Arguments:</strong>
<ul>
<li><code>data_store</code>: The data store to use.</li>
</ul>
</li>
<li><strong>Returns:</strong>
<ul>
<li>The current nonce value.</li>
</ul>
</li>
</ul>
<h3 id="increment_nonce"><a class="header" href="#increment_nonce"><code>increment_nonce</code></a></h3>
<ul>
<li>Increments the current nonce value in the data store.</li>
<li><strong>Arguments:</strong>
<ul>
<li><code>data_store</code>: The data store to use.</li>
</ul>
</li>
<li><strong>Returns:</strong>
<ul>
<li>The new nonce value.</li>
</ul>
</li>
</ul>
<h3 id="get_next_key"><a class="header" href="#get_next_key"><code>get_next_key</code></a></h3>
<ul>
<li>Computes a <code>felt252</code> hash using the next nonce and can also use the nonce directly as a key.</li>
<li><strong>Arguments:</strong>
<ul>
<li><code>data_store</code>: The data store to use.</li>
</ul>
</li>
<li><strong>Returns:</strong>
<ul>
<li>The <code>felt252</code> hash using the next nonce value.</li>
</ul>
</li>
</ul>
<h2 id="core-logic"><a class="header" href="#core-logic">Core Logic</a></h2>
<h3 id="compute_key"><a class="header" href="#compute_key"><code>compute_key</code></a></h3>
<ul>
<li>Computes a key using the provided <code>data_store_address</code> and <code>nonce</code>.</li>
<li><strong>Arguments:</strong>
<ul>
<li><code>data_store_address</code>: The address of the data store.</li>
<li><code>nonce</code>: The nonce value.</li>
</ul>
</li>
<li><strong>Returns:</strong>
<ul>
<li>A <code>felt252</code> key.</li>
</ul>
</li>
</ul>
<h2 id="errors-8"><a class="header" href="#errors-8">Errors</a></h2>
<p>The module defines specific errors to handle nonce-specific anomalies and invalid operations, ensuring smooth and accurate operations within the module. </p>
<h2 id="usage-example-8"><a class="header" href="#usage-example-8">Usage Example</a></h2>
<pre><code class="language-cairo">// Example of getting the next key
let data_store: IDataStoreDispatcher = /* ... */;
let next_key: felt252 = nonce_utils::get_next_key(data_store);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="oracle-module"><a class="header" href="#oracle-module">Oracle Module</a></h1>
<p>The purpose of the oracle module is to validate and store signed values.</p>
<h2 id="price-representation-in-oracle"><a class="header" href="#price-representation-in-oracle">Price representation in Oracle</a></h2>
<p>Representing the prices in this way allows for conversions between token amounts
and fiat values to be simplified, e.g. to calculate the fiat value of a given
number of tokens the calculation would just be: <code>token amount * oracle price</code>,
to calculate the token amount for a fiat value it would be: <code>fiat value / oracle price</code>.</p>
<p>The trade-off of this simplicity in calculation is that tokens with a small USD
price and a lot of decimals may have precision issues it is also possible that
a token's price changes significantly and results in requiring higher precision.</p>
<h3 id="example-1"><a class="header" href="#example-1">Example 1</a></h3>
<p>The price of ETH is 5000, and ETH has 18 decimals.</p>
<p>The price of one unit of ETH is <code>5000 (10 ^ 18), 5 * (10 ^ -15)</code>.</p>
<p>To handle the decimals, multiply the value by <code>(10 ^ 30)</code>.</p>
<p>Price would be stored as <code>5000 (10 ^ 18) * (10 ^ 30) =&gt; 5000 * (10 ^ 12)</code>.</p>
<p>For gas optimization, these prices are sent to the oracle in the form of a uint8
decimal multiplier value and uint32 price value.</p>
<p>If the decimal multiplier value is set to 8, the uint32 value would be <code>5000 * (10 ^ 12) (10 ^ 8) =&gt; 5000 * (10 ^ 4)</code>.</p>
<p>With this config, ETH prices can have a maximum value of <code>(2 ^ 32) (10 ^ 4) =&gt; 4,294,967,296 (10 ^ 4) =&gt; 429,496.7296</code> with 4 decimals of precision.</p>
<h3 id="example-2"><a class="header" href="#example-2">Example 2</a></h3>
<p>The price of BTC is 60,000, and BTC has 8 decimals.</p>
<p>The price of one unit of BTC is <code>60,000 (10 ^ 8), 6 * (10 ^ -4)</code>.</p>
<p>Price would be stored as <code>60,000 (10 ^ 8) * (10 ^ 30) =&gt; 6 * (10 ^ 26) =&gt; 60,000 * (10 ^ 22)</code>.</p>
<p>BTC prices maximum value: <code>(2 ^ 32) (10 ^ 2) =&gt; 4,294,967,296 (10 ^ 2) =&gt; 42,949,672.96</code>.</p>
<p>Decimals of precision: 2.</p>
<h3 id="example-3"><a class="header" href="#example-3">Example 3</a></h3>
<p>The price of USDC is 1, and USDC has 6 decimals.</p>
<p>The price of one unit of USDC is <code>1 (10 ^ 6), 1 * (10 ^ -6)</code>.</p>
<p>Price would be stored as <code>1 (10 ^ 6) * (10 ^ 30) =&gt; 1 * (10 ^ 24)</code>.</p>
<p>USDC prices maximum value: <code>(2 ^ 64) (10 ^ 6) =&gt; 4,294,967,296 (10 ^ 6) =&gt; 4294.967296</code>.</p>
<p>Decimals of precision: 6.</p>
<h3 id="example-4"><a class="header" href="#example-4">Example 4</a></h3>
<p>The price of DG is 0.00000001, and DG has 18 decimals.</p>
<p>The price of one unit of DG is <code>0.00000001 (10 ^ 18), 1 * (10 ^ -26)</code>.</p>
<p>Price would be stored as <code>1 * (10 ^ -26) * (10 ^ 30) =&gt; 1 * (10 ^ 3)</code>.</p>
<p>DG prices maximum value: <code>(2 ^ 64) (10 ^ 11) =&gt; 4,294,967,296 (10 ^ 11) =&gt; 0.04294967296</code>.</p>
<p>Decimals of precision: 11.</p>
<h3 id="decimal-multiplier"><a class="header" href="#decimal-multiplier">Decimal Multiplier</a></h3>
<p>The formula to calculate what the decimal multiplier value should be set to:</p>
<p>Decimals: 30 - (token decimals) - (number of decimals desired for precision)</p>
<ul>
<li>ETH: 30 - 18 - 4 =&gt; 8</li>
<li>BTC: 30 - 8 - 2 =&gt; 20</li>
<li>USDC: 30 - 6 - 6 =&gt; 18</li>
<li>DG: 30 - 18 - 11 =&gt; 1.</li>
</ul>
<h3 id="oracle-primary-and-secondary-price"><a class="header" href="#oracle-primary-and-secondary-price">Oracle primary and secondary price</a></h3>
<p>It is possible to update the oracle to support a primary_price and a secondary_price
which would allow for stop-loss orders to be executed at exactly the trigger_price</p>
<p>However, this may lead to gaming issues, an example:</p>
<ul>
<li>The current price is $2020</li>
<li>A user has a long position and creates a stop-loss decrease order for &lt; $2010</li>
<li>If the order has a swap from ETH to USDC and the user is able to cause the order
to be frozen / unexecutable by manipulating state or otherwise</li>
<li>Then if price decreases to $2000, and the user is able to manipulate state such that
the order becomes executable with $2010 being used as the price instead</li>
<li>Then the user would be able to perform the swap at a higher price than should possible</li>
</ul>
<p>Additionally, using the exact order's trigger_price could lead to gaming issues during times
of volatility due to users setting tight stop-losses to minimize loss while betting on a
directional price movement, fees and price impact should help a bit with this, but there
still may be some probability of success</p>
<p>The order keepers can use the closest oracle price to the trigger_price for execution, which
should lead to similar order execution prices with reduced gaming risks</p>
<p>If an order is frozen, the frozen order keepers should use the most recent price for order
execution instead</p>
<hr />
<p>It contains the following files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/oracle/oracle_modules.cairo">oracle_modules.cairo</a>: Modifiers for oracles.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/oracle/oracle_modules.cairo">oracle_store.cairo</a>: Storage for oracles.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/oracle/oracle_utils.cairo">oracle_utils.cairo</a>: Contains utility structs and functions for Oracles.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/oracle/oracle_modules.cairo">oracle.cairo</a>: Main oracle smart contract.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="order-module"><a class="header" href="#order-module">Order Module</a></h1>
<p>The Order Module is key for handling orders in the system. It’s important for changing, processing, and looking after orders.</p>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>This module centralizes the logic related to orders, managing various aspects including processing increasing and decreasing orders, structuring orders, and providing utilities for common order-related operations. Its design allows developers to interact with, modify, or extend the functionalities with ease and precision.</p>
<h2 id="smart-contracts-2"><a class="header" href="#smart-contracts-2">Smart Contracts</a></h2>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/order/order_vault.cairo">OrderVault.cairo</a>: Acts as a secure vault for orders, ensuring their safe storage and accessibility.</li>
</ul>
<h2 id="cairo-library-files-1"><a class="header" href="#cairo-library-files-1">Cairo Library Files</a></h2>
<h3 id="base_order_utilscairo"><a class="header" href="#base_order_utilscairo"><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/order/base_order_utils.cairo">base_order_utils.cairo</a></a></h3>
<p>A collection of essential functions facilitating common order-related operations, enhancing code reusability and organization.</p>
<h3 id="decrease_order_utilscairo"><a class="header" href="#decrease_order_utilscairo"><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/order/decrease_order_utils.cairo">decrease_order_utils.cairo</a></a></h3>
<p>Contains functions aiding in the processing of decreasing orders, ensuring their accurate and efficient handling.</p>
<h3 id="increase_order_utilscairo"><a class="header" href="#increase_order_utilscairo"><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/order/increase_order_utils.cairo">increase_order_utils.cairo</a></a></h3>
<p>Comprises functions to assist in processing increasing orders, maintaining precision and efficiency in operations.</p>
<h3 id="ordercairo"><a class="header" href="#ordercairo"><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/order/order.cairo">order.cairo</a></a></h3>
<p>Defines the structure for orders, serving as a blueprint for order objects within the system.</p>
<h3 id="order_utilscairo"><a class="header" href="#order_utilscairo"><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/order/order_utils.cairo">order_utils.cairo</a></a></h3>
<p>Encompasses various order-related functions, offering utilities to streamline order processing and management.</p>
<h2 id="detailed-structure-and-types"><a class="header" href="#detailed-structure-and-types">Detailed Structure and Types</a></h2>
<h3 id="order"><a class="header" href="#order"><code>Order</code></a></h3>
<ul>
<li>Represents the blueprint for creating order objects, defining the properties and characteristics of an order within the system.</li>
</ul>
<h4 id="properties"><a class="header" href="#properties">Properties</a></h4>
<ul>
<li><strong>key</strong>: A unique identifier of the order of type <code>felt252</code>.</li>
<li><strong>order_type</strong>: Specifies the type of order from the enumerated <code>OrderType</code>.</li>
<li><strong>decrease_position_swap_type</strong>: Specifies the type of swap for decreasing position orders from the enumerated <code>DecreasePositionSwapType</code>.</li>
<li><strong>account</strong>: The account of the user creating the order, represented as a <code>ContractAddress</code>.</li>
<li><strong>receiver</strong>: The receiver for any token transfers, represented as a <code>ContractAddress</code>.</li>
<li><strong>callback_contract</strong>: The contract to call for callbacks, represented as a <code>ContractAddress</code>.</li>
<li><strong>ui_fee_receiver</strong>: The UI fee receiver, represented as a <code>ContractAddress</code>.</li>
<li><strong>market</strong>: The trading market's contract address.</li>
<li><strong>initial_collateral_token</strong>: The initial collateral token for increase orders, represented as a <code>ContractAddress</code>.</li>
<li><strong>swap_path</strong>: An array of market addresses to swap through.</li>
<li><strong>size_delta_usd</strong>: The requested change in position size, represented as <code>u128</code>.</li>
<li><strong>initial_collateral_delta_amount</strong>: Represents different amounts based on the order, either the amount of the initialCollateralToken sent in by the user for increase orders, the amount of the position's collateralToken to withdraw for decrease orders, or the amount of initialCollateralToken sent in for the swap, represented as <code>u128</code>.</li>
<li><strong>trigger_price</strong>: The trigger price for non-market orders, represented as <code>u128</code>.</li>
<li><strong>acceptable_price</strong>: The acceptable execution price for increase/decrease orders, represented as <code>u128</code>.</li>
<li><strong>execution_fee</strong>: The execution fee for keepers, represented as <code>u128</code>.</li>
<li><strong>callback_gas_limit</strong>: The gas limit for the callbackContract, represented as <code>u128</code>.</li>
<li><strong>min_output_amount</strong>: The minimum output amount for decrease orders and swaps, represented as <code>u128</code>.</li>
<li><strong>updated_at_block</strong>: The block at which the order was last updated, represented as <code>u64</code>.</li>
<li><strong>is_long</strong>: Boolean flag indicating whether the order is for a long or short.</li>
<li><strong>is_frozen</strong>: Boolean flag indicating whether the order is frozen.</li>
</ul>
<h3 id="enumerations"><a class="header" href="#enumerations">Enumerations</a></h3>
<h4 id="ordertype"><a class="header" href="#ordertype"><code>OrderType</code></a></h4>
<p>Enumerates the various types of orders that can be created in the system, including MarketSwap, LimitSwap, MarketIncrease, LimitIncrease, MarketDecrease, LimitDecrease, StopLossDecrease, and Liquidation.</p>
<h4 id="decreasepositionswaptype"><a class="header" href="#decreasepositionswaptype"><code>DecreasePositionSwapType</code></a></h4>
<p>Indicates whether the decrease order should swap the pnl token to collateral token or vice versa, with possible values being NoSwap, SwapPnlTokenToCollateralToken, and SwapCollateralTokenToPnlToken.</p>
<h4 id="secondaryordertype"><a class="header" href="#secondaryordertype"><code>SecondaryOrderType</code></a></h4>
<p>Further differentiates orders, with possible values being None and Adl.</p>
<h2 id="core-functionalities-and-methods"><a class="header" href="#core-functionalities-and-methods">Core Functionalities and Methods</a></h2>
<h3 id="touch"><a class="header" href="#touch"><code>touch</code></a></h3>
<p>Updates the <code>updated_at_block</code> property of the order to the current block number.</p>
<h3 id="ordertypeinto"><a class="header" href="#ordertypeinto"><code>OrderTypeInto</code></a></h3>
<p>Converts the enumerated <code>OrderType</code> to a <code>felt252</code> type.</p>
<h3 id="ordertypeprintimpl"><a class="header" href="#ordertypeprintimpl"><code>OrderTypePrintImpl</code></a></h3>
<p>Prints the corresponding string representation of the <code>OrderType</code>.</p>
<h3 id="secondaryordertypeprintimpl"><a class="header" href="#secondaryordertypeprintimpl"><code>SecondaryOrderTypePrintImpl</code></a></h3>
<p>Prints the corresponding string representation of the <code>SecondaryOrderType</code>.</p>
<h3 id="decreasepositionswaptypeprintimpl"><a class="header" href="#decreasepositionswaptypeprintimpl"><code>DecreasePositionSwapTypePrintImpl</code></a></h3>
<p>Prints the corresponding string representation of the <code>DecreasePositionSwapType</code>.</p>
<h3 id="defaultorder"><a class="header" href="#defaultorder"><code>DefaultOrder</code></a></h3>
<p>Provides a default implementation for creating a new <code>Order</code> instance with default values.</p>
<h2 id="errors-9"><a class="header" href="#errors-9">Errors</a></h2>
<p>The module delineates specific error cases to manage anomalies and invalid operations related to orders, ensuring seamless execution of order operations and facilitating troubleshooting and debugging.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="position-module"><a class="header" href="#position-module">Position Module</a></h1>
<p>The purpose of the position module is to help with management of positions.</p>
<h2 id="fees-in-position"><a class="header" href="#fees-in-position">Fees in position</a></h2>
<p>Borrowing fees for position require only a borrowing_factor to track. An example on how this works is if the global cumulative_borrowing_factor is 10020% a position would be opened with borrowingFactor as 10020%. After some time, if the cumulative_borrowing_factor is updated to 10025% the position would owe 5% of the position size as borrowing fees. The total pending borrowing fees of all positions is factored into the calculation of the pool value for LPs. When a position is increased or decreased, the pending borrowing fees for the position is deducted from the position's
collateral and transferred into the LP pool.</p>
<p>The same borrowing fee factor tracking cannot be applied for funding fees as those calculations consider pending funding fees based on the fiat value of the position sizes.</p>
<p>For example, if the price of the long_token is $2000 and a long position owes $200 in funding fees, the opposing short position claims the funding fees of 0.1 longToken ($200), if the price of the longToken changes to $4000 later, the long position would only owe 0.05 longToken ($200). This would result in differences between the amounts deducted and amounts paid out, for this reason, the actual token amounts to be deducted and to be paid out need to be tracked instead.</p>
<p>For funding fees, there are four values to consider:</p>
<ol>
<li>long positions with market.long_token as collateral.</li>
<li>long positions with market.short_token as collateral.</li>
<li>short positions with market.long_token as collateral.</li>
<li>short positions with market.short_token as collateral.</li>
</ol>
<hr />
<p>It contains the following files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/decrease_position_collateral_utils.cairo">decrease_position_collateral_utils.cairo</a>: Library for functions to help with the calculations when decreasing a position.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/decrease_position_swap_utils.cairo">decrease_position_swap_utils.cairo</a>: Library for functions related to decrease of position involving swaps.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/decrease_position_utils.cairo">decrease_position_utils.cairo</a>: Library for functions to help with decreasing a position.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/increase_position_utils.cairo">increase_position_utils.cairo</a>: Library for functions to help with increasing a position.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/position_event_utils.cairo">position_event_utils.cairo</a>: Library with helper functions to emit position related events.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/position_utils.cairo">position_utils.cairo</a>: Library with various utility functions for positions.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/position/position.cairo">position.cairo</a>: Contains main Position struct.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="price-module"><a class="header" href="#price-module">Price Module</a></h1>
<p>The Price Module helps manage everything related to prices. It organizes how to handle lowest and highest prices and makes working with these prices easier.</p>
<h2 id="cairo-library-files-2"><a class="header" href="#cairo-library-files-2">Cairo Library Files</a></h2>
<h3 id="pricecairo"><a class="header" href="#pricecairo"><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/price/price.cairo">price.cairo</a></a></h3>
<p>Defines the <code>Price</code> struct and associated methods, serving as a utility to streamline price-related operations in contracts.</p>
<h2 id="structures-and-types-8"><a class="header" href="#structures-and-types-8">Structures and Types</a></h2>
<h3 id="price"><a class="header" href="#price"><code>Price</code></a></h3>
<p>This struct holds the minimum and maximum prices and provides a set of methods to perform various operations using these prices.</p>
<ul>
<li><strong>min</strong>: The minimum price, represented as <code>u128</code>.</li>
<li><strong>max</strong>: The maximum price, represented as <code>u128</code>.</li>
</ul>
<h2 id="trait-and-implementations"><a class="header" href="#trait-and-implementations">Trait and Implementations</a></h2>
<h3 id="pricetrait"><a class="header" href="#pricetrait"><code>PriceTrait</code></a></h3>
<p>This trait defines a set of methods that can be performed on a <code>Price</code> struct.</p>
<h4 id="methods"><a class="header" href="#methods">Methods</a></h4>
<ul>
<li>
<p><strong>mid_price</strong>:</p>
<ul>
<li>Returns the average of the min and max values of the <code>Price</code> struct.</li>
<li>Arguments:
<ul>
<li><code>self</code>: The <code>Price</code> struct.</li>
</ul>
</li>
<li>Returns: The average of the min and max values as <code>u128</code>.</li>
</ul>
</li>
<li>
<p><strong>pick_price</strong>:</p>
<ul>
<li>Picks either the min or max value based on the <code>maximize</code> parameter.</li>
<li>Arguments:
<ul>
<li><code>self</code>: The <code>Price</code> struct.</li>
<li><code>maximize</code>: If true, picks the max value. Otherwise, picks the min value.</li>
</ul>
</li>
<li>Returns: The min or max value as <code>u128</code>.</li>
</ul>
</li>
<li>
<p><strong>pick_price_for_pnl</strong>:</p>
<ul>
<li>Picks the min or max price depending on whether it is for a long or short position, and whether the pending pnl should be maximized or not.</li>
<li>Arguments:
<ul>
<li><code>self</code>: The <code>Price</code> struct.</li>
<li><code>is_long</code>: Whether it is for a long or a short position.</li>
<li><code>maximize</code>: Whether the pending pnl should be maximized or not.</li>
</ul>
</li>
<li>Returns: The min or max price as <code>u128</code>.</li>
</ul>
</li>
</ul>
<h3 id="priceimpl"><a class="header" href="#priceimpl"><code>PriceImpl</code></a></h3>
<p>This implementation block provides concrete implementations for the methods defined in the <code>PriceTrait</code> for a <code>Price</code> struct.</p>
<h3 id="pricezeroable"><a class="header" href="#pricezeroable"><code>PriceZeroable</code></a></h3>
<p>This implementation block provides methods to create a zero <code>Price</code> struct and check whether a <code>Price</code> struct is zero or non-zero.</p>
<h4 id="methods-1"><a class="header" href="#methods-1">Methods</a></h4>
<ul>
<li>
<p><strong>zero</strong>:</p>
<ul>
<li>Returns a <code>Price</code> struct with min and max values set to 0.</li>
<li>Returns: A zero <code>Price</code> struct.</li>
</ul>
</li>
<li>
<p><strong>is_zero</strong>:</p>
<ul>
<li>Checks whether the <code>Price</code> struct is zero.</li>
<li>Arguments:
<ul>
<li><code>self</code>: The <code>Price</code> struct.</li>
</ul>
</li>
<li>Returns: A boolean value indicating whether the <code>Price</code> struct is zero.</li>
</ul>
</li>
<li>
<p><strong>is_non_zero</strong>:</p>
<ul>
<li>Checks whether the <code>Price</code> struct is non-zero.</li>
<li>Arguments:
<ul>
<li><code>self</code>: The <code>Price</code> struct.</li>
</ul>
</li>
<li>Returns: A boolean value indicating whether the <code>Price</code> struct is non-zero.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pricing-module"><a class="header" href="#pricing-module">Pricing module</a></h1>
<p>The pricing module is responsible for functions linked to price computations.</p>
<h2 id="price-impact"><a class="header" href="#price-impact">Price impact</a></h2>
<p>Price impact is calculated as:</p>
<pre><code>(initial imbalance) ^ (price impact exponent) * (price impact factor / 2) - (next imbalance) ^ (price impact exponent) * (price impact factor / 2)
</code></pre>
<p>For spot actions (deposits, withdrawals, swaps), imbalance is calculated as the
difference in the worth of the long tokens and short tokens.</p>
<p>For example:</p>
<ul>
<li>A pool has 10 long tokens, each long token is worth $5000</li>
<li>The pool also has 50,000 short tokens, each short token is worth $1</li>
<li>The <code>price impact exponent</code> is set to 2 and <code>price impact factor</code> is set
to <code>0.01 / 50,000</code></li>
<li>The pool is equally balanced with $50,000 of long tokens and $50,000 of
short tokens</li>
<li>If a user deposits 10 long tokens, the pool would now have $100,000 of long
tokens and $50,000 of short tokens</li>
<li>The change in imbalance would be from $0 to -$50,000</li>
<li>There would be negative price impact charged on the user's deposit,
calculated as <code>0 ^ 2 * (0.01 / 50,000) - 50,000 ^ 2 * (0.01 / 50,000) =&gt; -$500</code></li>
<li>If the user now withdraws 5 long tokens, the balance would change
from -$50,000 to -$25,000, a net change of +$25,000</li>
<li>There would be a positive price impact rebated to the user in the form of
additional long tokens, calculated as <code>50,000 ^ 2 * (0.01 / 50,000) - 25,000 ^ 2 * (0.01 / 50,000) =&gt; $375</code></li>
</ul>
<p>For position actions (increase / decrease position), imbalance is calculated
as the difference in the long and short open interest.</p>
<p><code>price impact exponents</code> and <code>price impact factors</code> are configured per market
and can differ for spot and position actions.</p>
<p>The purpose of the price impact is to help reduce the risk of price manipulation,
since the contracts use an oracle price which would be an average or median price
of multiple reference exchanges. Without a price impact, it may be profitable to
manipulate the prices on reference exchanges while executing orders on the contracts.</p>
<p>This risk will also be present if the positive and negative price impact values
are similar, for that reason the positive price impact should be set to a low
value in times of volatility or irregular price movements.</p>
<p>It contains the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/pricing/position_pricing_utils.cairo">position_pricing_utils.cairo</a>: Library for position pricing functions.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/pricing/pricing_utils.cairo">pricing_utils.cairo</a>: Library for pricing functions.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/pricing/swap_pricing_utils.cairo">swap_pricing_utils.cairo</a>: Library for pricing functions linked to swaps.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reader-module"><a class="header" href="#reader-module">Reader Module</a></h1>
<p>The Reader Module gets market data and is like a utility library for trading. It’s especially important for markets that need lots of calculations and data for operating and evaluating the market.</p>
<h2 id="cairo-library-files-3"><a class="header" href="#cairo-library-files-3">Cairo Library Files</a></h2>
<p>The module contains the following Cairo files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/reader/reader_pricing_utils.cairo">reader_pricing_utils.cairo</a>: Utility functions for trading price calculations, impact, and fees.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/reader/reader_utils.cairo">reader_utils.cairo</a>: External utility functions for trading operations.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/reader/reader.cairo">reader.cairo</a>: Library for reading and calculating financial market data and trading operations.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="referral-module"><a class="header" href="#referral-module">Referral Module</a></h1>
<p>The Referral Module handles user referrals, giving discounts and paybacks. It’s key for encouraging people to bring in others and rewarding them for helping the platform grow.</p>
<p>It contains the following Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/referral/referral_tier.cairo">referral_tier.cairo</a>: Defines the <code>ReferralTier</code> struct and contains related functionalities.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/referral/referral_utils.cairo">referral_utils.cairo</a>: Houses various referral utility functions essential for managing referrals within the platform.</li>
</ul>
<h2 id="structures-and-types-9"><a class="header" href="#structures-and-types-9">Structures and Types</a></h2>
<h3 id="referraltier"><a class="header" href="#referraltier"><code>ReferralTier</code></a></h3>
<p>This struct encapsulates the total rebate for the tier, which is the sum of the affiliate reward and trader discount, and the share of the total rebate designated for traders.</p>
<h2 id="functions-10"><a class="header" href="#functions-10">Functions</a></h2>
<h3 id="set_trader_referral_code"><a class="header" href="#set_trader_referral_code"><code>set_trader_referral_code</code></a></h3>
<p>This function sets the referral code for a trader and is vital for linking traders to their referrers, ensuring that the correct users receive their due rewards.</p>
<h3 id="increment_affiliate_reward"><a class="header" href="#increment_affiliate_reward"><code>increment_affiliate_reward</code></a></h3>
<p>It increments the affiliate's reward balance by a specified delta, updating the reward balance and emitting an event signaling the update.</p>
<h3 id="get_referral_info"><a class="header" href="#get_referral_info"><code>get_referral_info</code></a></h3>
<p>Retrieves the referral information for a specified trader, returning the referral code, the affiliate's address, the total rebate, and the discount share. It plays a crucial role in fetching referral details needed for various operations, like calculating rebates and discounts.</p>
<h3 id="claim_affiliate_reward"><a class="header" href="#claim_affiliate_reward"><code>claim_affiliate_reward</code></a></h3>
<p>Allows claiming of the affiliate reward. It returns the reward amount and updates relevant balances and states to reflect the claimed reward.</p>
<h2 id="errors-10"><a class="header" href="#errors-10">Errors</a></h2>
<p>Specific error handling would be defined to manage any anomalies in referral operations, such as invalid referral codes, non-existent affiliates, etc., ensuring the robustness and reliability of the referral system.</p>
<h2 id="imports"><a class="header" href="#imports">Imports</a></h2>
<h3 id="core-library-imports"><a class="header" href="#core-library-imports">Core Library Imports</a></h3>
<ul>
<li><code>starknet</code>: Used for core functionalities and structures in Starknet contracts.</li>
<li>Several other local imports from the <code>satoru</code> project for various functionalities like data storage, event emission, and market utilities.</li>
</ul>
<h3 id="local-imports-from-satoru-project"><a class="header" href="#local-imports-from-satoru-project">Local Imports from <code>satoru</code> project</a></h3>
<ul>
<li><code>referral_storage</code>: For managing referral-related data storage operations.</li>
<li><code>data_store</code>: Centralized data storage used for storing and retrieving information about referrals, rewards, etc.</li>
<li><code>event_emitter</code>: Utilized for emitting events on the blockchain, allowing users and other contracts to track changes in the system.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="role-module"><a class="header" href="#role-module">Role Module</a></h1>
<p>The Role Module is crucial for managing who has access to what, controlling the assignment and removal of roles to different accounts in the system.</p>
<p>It consists of the following smart contracts and Cairo library files:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/role/role_store.cairo">RoleStore</a>: The central contract of the module, focusing on storing roles and managing access control across the protocol.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/role/role.cairo">role.cairo</a>: Holds the definitions of different roles existing within the protocol.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/role/error.cairo">error.cairo</a>: Encompasses the error codes specific to this module.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/role/role_module.cairo">role_module.cairo</a>: Implements the <code>RoleModule</code> contract interface, focusing on role validation and interaction with <code>RoleStore</code>.</li>
</ul>
<h3 id="features-of-role_modulecairo"><a class="header" href="#features-of-role_modulecairo">Features of role_module.cairo</a></h3>
<ul>
<li><strong>Initialization</strong>: It initializes the role store with the provided address.</li>
<li><strong>Role Validation Functions</strong>: Provides a set of functions like <code>only_timelock_admin</code>, <code>only_controller</code>, etc., each validating a specific role in the protocol.</li>
<li><strong>Role Verification</strong>: Utilizes <code>RoleStore</code> to verify if an account holds the specified role, ensuring secure and accurate role-based access control.</li>
<li><strong>Access Restriction</strong>: Employs role validation to restrict access to specific functions, maintaining the protocol's security and integrity.</li>
</ul>
<h2 id="roles-defined"><a class="header" href="#roles-defined">Roles Defined</a></h2>
<p>The following roles are defined within the protocol:</p>
<ul>
<li><code>ADMIN</code></li>
<li><code>TIMELOCK_ADMIN</code></li>
<li><code>TIMELOCK_MULTISIG</code></li>
<li><code>CONFIG_KEEPER</code></li>
<li><code>CONTROLLER</code></li>
<li><code>ROUTER_PLUGIN</code></li>
<li><code>MARKET_KEEPER</code></li>
<li><code>FEE_KEEPER</code></li>
<li><code>ORDER_KEEPER</code></li>
<li><code>FROZEN_ORDER_KEEPER</code></li>
<li><code>PRICING_KEEPER</code></li>
<li><code>LIQUIDATION_KEEPER</code></li>
<li><code>ADL_KEEPER</code></li>
</ul>
<p>These roles are represented by constants defined in <code>role.cairo</code>, and they are essential in maintaining the integrity and functionality of the system by granting specific permissions to different accounts.</p>
<h2 id="functions-11"><a class="header" href="#functions-11">Functions</a></h2>
<h3 id="has_role"><a class="header" href="#has_role"><code>has_role</code></a></h3>
<p>Determines whether a given account holds a specified role.</p>
<h3 id="grant_role"><a class="header" href="#grant_role"><code>grant_role</code></a></h3>
<p>Assigns a particular role to a specific account.</p>
<h3 id="revoke_role"><a class="header" href="#revoke_role"><code>revoke_role</code></a></h3>
<p>Removes a designated role from a given account.</p>
<h3 id="assert_only_role"><a class="header" href="#assert_only_role"><code>assert_only_role</code></a></h3>
<p>Ensures that a specified account holds only a particular role, reverting if the condition is not met.</p>
<h3 id="get_role_count"><a class="header" href="#get_role_count"><code>get_role_count</code></a></h3>
<p>Returns the number of roles stored within the contract.</p>
<h3 id="get_roles"><a class="header" href="#get_roles"><code>get_roles</code></a></h3>
<p>Retrieves the keys of roles stored within the contract, based on the provided range of indices.</p>
<h3 id="get_role_member_count"><a class="header" href="#get_role_member_count"><code>get_role_member_count</code></a></h3>
<p>Returns the number of members assigned to a specified role.</p>
<h3 id="get_role_members"><a class="header" href="#get_role_members"><code>get_role_members</code></a></h3>
<p>Retrieves the members of a specified role, based on the given range of indices.</p>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="rolegranted"><a class="header" href="#rolegranted"><code>RoleGranted</code></a></h3>
<p>Emitted when a role is assigned to an account.</p>
<h3 id="rolerevoked"><a class="header" href="#rolerevoked"><code>RoleRevoked</code></a></h3>
<p>Emitted when a role is removed from an account.</p>
<h2 id="errors-11"><a class="header" href="#errors-11">Errors</a></h2>
<h3 id="unauthorized_access"><a class="header" href="#unauthorized_access"><code>UNAUTHORIZED_ACCESS</code></a></h3>
<p>Indicates that an operation was attempted by an account lacking the necessary role.</p>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<pre><code class="language-cairo">// Granting a role to an account
RoleStore.grant_role(account: ContractAddress, role_key: 'ADMIN')</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="router-module"><a class="header" href="#router-module">Router module</a></h1>
<p>The exchange router is the place where users go to start token trades, swaps, and moves.</p>
<h2 id="front-running-solution"><a class="header" href="#front-running-solution">Front-running solution</a></h2>
<p>To avoid front-running issues, most actions require two steps to execute:</p>
<ul>
<li>User sends transaction with request details, e.g. deposit / withdraw liquidity,
swap, increase / decrease position.</li>
<li>Keepers listen for the transactions, include the prices for the request then
send a transaction to execute the request.</li>
</ul>
<h2 id="oracle-keepers"><a class="header" href="#oracle-keepers">Oracle keepers</a></h2>
<p>Prices are provided by an off-chain oracle system:</p>
<ul>
<li>Oracle keepers continually check the latest blocks.</li>
<li>When there is a new block, oracle keepers fetch the latest prices from
reference exchanges.</li>
<li>Oracle keepers then sign the median price for each token together with
the block hash.</li>
<li>Oracle keepers then send the data and signature to archive nodes.</li>
<li>Archive nodes display this information for anyone to query.</li>
</ul>
<h3 id="example-1"><a class="header" href="#example-1">Example</a></h3>
<ul>
<li>Block 100 is finalized on the blockchain.</li>
<li>Oracle keepers observe this block.</li>
<li>Oracle keepers pull the latest prices from reference exchanges,
token A: price 20,000, token B: price 80,000.</li>
<li>Oracle keepers sign [chainId, blockhash(100), 20,000], [chainId, blockhash(100), 80,000].</li>
<li>If in block 100, there was a market order to open a long position for token A,
the market order would have a block number of 100.</li>
<li>The prices signed at block 100 can be used to execute this order.</li>
<li>Order keepers would bundle the signature and price data for token A
then execute the order.</li>
</ul>
<p>It contains the following smart contracts:</p>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/router/router.cairo">Router</a>: Users will approve this router for token expenditures.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/router/exchange_router.cairo">ExchangeRouter</a>: Router for exchange functions, supports functions which require token transfers from the user.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="swap-module"><a class="header" href="#swap-module">Swap Module</a></h1>
<p>The Swap Module is crucial for switching one token for another in the system. It makes sure the swap meets market conditions, adjusting for things like price changes and fees.</p>
<h2 id="smart-contracts-3"><a class="header" href="#smart-contracts-3">Smart Contracts</a></h2>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/swap/swap_handler">SwapHandler</a>: This contract is responsible for handling swaps, ensuring that only authorized entities can invoke the swap function. It validates the swap parameters and interacts with the <code>swap_utils</code> to perform the swap.</li>
</ul>
<h2 id="cairo-library-files-4"><a class="header" href="#cairo-library-files-4">Cairo Library Files</a></h2>
<ul>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/swap/swap_utils.cairo">swap_utils.cairo</a>: Implements the logic for performing swaps, including validating markets, calculating price impacts, applying fees, and transferring tokens.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/swap/error.cairo">error.cairo</a>: Defines errors specific to the Swap Module, handling cases like insufficient output amount, invalid input token, and duplicated market in swap path.</p>
</li>
</ul>
<h2 id="structures-and-types-10"><a class="header" href="#structures-and-types-10">Structures and Types</a></h2>
<h3 id="swapparams"><a class="header" href="#swapparams"><code>SwapParams</code></a></h3>
<p>This struct is used to pass parameters needed for executing a swap. It includes fields like:</p>
<ul>
<li><code>data_store</code>: Provides access to on-chain data storage.</li>
<li><code>event_emitter</code>: Enables the emission of events.</li>
<li><code>oracle</code>: Provides access to price data from oracles.</li>
<li><code>bank</code>: Provides the funds for the swap.</li>
<li><code>token_in</code>: The address of the token being swapped.</li>
<li><code>amount_in</code>: The amount of the token being swapped.</li>
<li><code>swap_path_markets</code>: An array specifying the markets in which the swap should be executed.</li>
<li><code>min_output_amount</code>: The minimum amount of tokens that should be received as part of the swap.</li>
<li><code>receiver</code>: The address where the swapped tokens should be sent.</li>
</ul>
<h3 id="swapcache"><a class="header" href="#swapcache"><code>SwapCache</code></a></h3>
<p>This struct caches data during a swap operation, including token addresses, prices, amounts, and price impacts.</p>
<h2 id="functions-12"><a class="header" href="#functions-12">Functions</a></h2>
<h3 id="swap-1"><a class="header" href="#swap-1"><code>swap</code></a></h3>
<p>Executes a swap based on the given <code>SwapParams</code>, returning the address of the received token and the amount of the received token. It handles edge cases, such as zero amount in or empty swap path markets, and applies the swap to single or multiple markets as specified in the <code>swap_path_markets</code>.</p>
<h3 id="_swap"><a class="header" href="#_swap"><code>_swap</code></a></h3>
<p>Performs a swap on a single market, dealing with various conditions like token validity, price impact, and fees, and returns the token and amount that were swapped.</p>
<h2 id="errors-12"><a class="header" href="#errors-12">Errors</a></h2>
<h3 id="swaperror"><a class="header" href="#swaperror"><code>SwapError</code></a></h3>
<p>Handles errors like:</p>
<ul>
<li><code>INSUFFICIENT_OUTPUT_AMOUNT</code>: Triggered when the output amount is less than the minimum specified.</li>
<li><code>INVALID_TOKEN_IN</code>: Raised when the input token is not valid.</li>
<li><code>SWAP_PRICE_IMPACT_EXCEEDS_AMOUNT_IN</code>: Occurs when the price impact is more than the amount in.</li>
<li><code>DUPLICATED_MARKET_IN_SWAP_PATH</code>: Triggered when there is a duplicate market in the swap path.</li>
</ul>
<h2 id="usage-example-9"><a class="header" href="#usage-example-9">Usage Example</a></h2>
<pre><code class="language-cairo">let params = swap_utils::SwapParams {
    data_store: /* ... */,
    event_emitter: /* ... */,
    oracle: /* ... */,
    bank: /* ... */,
    key: /* ... */,
    token_in: /* ... */,
    amount_in: /* ... */,
    swap_path_markets: /* ... */,
    min_output_amount: /* ... */,
    receiver: /* ... */,
    ui_fee_receiver: /* ... */,
};
swap_utils::swap(params);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="utils-module"><a class="header" href="#utils-module">Utils module</a></h1>
<p>The Utils module is like a toolbox, filled with different helpful functions and tools that make tasks in the protocol easier. It’s a place for essential functions that don’t fit elsewhere but make the code clearer and more efficient.</p>
<p>It contains the following files:</p>
<ul>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/account_utils.cairo">account_utils.cairo</a>: This file is like a helper in the project, it has functions to check accounts and receivers in the system. It uses methods like <code>validate_account</code> and <code>validate_receiver</code> to make sure accounts in operations are valid and real, making interactions within the system safer and more secure. This checking is important to avoid mistakes and weaknesses from invalid or empty account interactions.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/array.cairo">array.cairo</a>: This file is a helper in the project, it has a bunch of functions for working with lists of items (arrays), which is important for managing data within the contract. It has functions like <code>get_felt252</code> and <code>get_u128</code> to safely get items from a list, and others like <code>are_eq</code>, <code>are_gt</code>, <code>are_gte</code>, <code>are_lt</code>, <code>are_lte</code> to compare items in the list to a certain value. This file is really important to make sure list operations are done safely and quickly, avoiding possible mistakes.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/basic_multicall.cairo">basic_multicall.cairo</a>: This utility’s job is to handle and run groups of function calls on a contract, letting many actions happen in one go. It’s really important for saving on gas and making smart contract interactions more efficient. The <code>multicall</code> function in this file takes a list of function calls and runs them one after the other.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/bits.cairo">bits.cairo</a>: This file has constants like <code>BITMASK_8</code>, <code>BITMASK_16</code>, <code>BITMASK_32</code>, and <code>BITMASK_64</code> that represent different sizes of binary words, used to do bit-level actions like shifting and changing bits on <code>u128</code> type values in the contract's code. They are really important for accurately changing binary data at a low level.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/calc.cairo">calc.cairo</a>: This file has many utility functions to do different math calculations and change types. It has functions for dividing, adding numbers with specific types, finding the absolute difference between two numbers, and adding and subtracting within limits to avoid going too high or too low. It also has functions to change between different types of numbers, making sure calculations in the contract's code are accurate and safe.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/enumerable_set.cairo">enumerable_set.cairo</a>: This file creates a special <code>Set</code> structure for handling collections of unique items. It lets you make new sets, add and remove items, check if an item is in a set, access items in specific spots, and get all items as a list. It has special versions for <code>felt252</code>, <code>ContractAddress</code>, and <code>u128</code> types, making it adaptable and accurate for different kinds of data in the protocol. The set operations in this file are really important for different parts of the project, helping manage unique collections efficiently and neatly.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/enumerable_values.cairo">enumerable_values.cairo</a>: This file is like an add-on to <code>EnumerableSet</code>, possibly offering more and specialized features to manage enumerable sets in the system. It has placeholder methods meant to give back lists of specific types of values (<code>felt252</code>, <code>ContractAddress</code>, <code>u128</code>) from a set, between certain start and end points.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/error_utils.cairo">error_utils.cairo</a>: This file is dedicated to providing functionalities related to error handling within the system.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/error.cairo">error.cairo</a>: This file defines constants for various types of errors, serving as standardized error messages or codes that can be referenced throughout the system to indicate specific error conditions.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/global_reentrancy_guard.cairo">global_reentrancy_guard.cairo</a>: This file puts in place a high-level protection to keep smart contract functions safe from reentrancy attacks. It uses a global flag, <code>REENTRANCY_GUARD_STATUS</code>, to show if a secured function is running, and has <code>non_reentrant_before</code> and <code>non_reentrant_after</code> methods to control this flag, stopping harmful reentrant calls and making sure the smart contract runs consistently.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/hash.cairo">hash.cairo</a>: This file has utility functions for creating hashes, specifically with the Poseidon hash function. It has a function, <code>hash_poseidon_single</code>, that lets you hash a single <code>felt252</code> value using Poseidon, making sure data stays intact and meeting the cryptographic needs in the smart contract.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/i128_test_storage_contract.cairo">i128_test_storage_contract.cairo</a>: This file creates a Starknet contract to test storing and getting <code>i128</code> values in the contract state. It’s a testing tool to make sure <code>i128</code> values are handled correctly in the smart contract environment.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/i128.cairo">i128.cairo</a>: This file has ways to work with <code>i128</code> (signed 128-bit integers) in Cairo, including doing math operations, turning them into strings and back, and managing storage, allowing for precise and efficient use of <code>i128</code> values in Starknet smart contracts.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/precision.cairo">precision.cairo</a>: This offers utility functions for detailed math and changing units, helping with accurate calculations and conversions between different measures, like from float to wei, applying factors, and managing rounding in the Satoru Starknet smart contract environment.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/serializable_dict.cairo">serializable_dict.cairo</a>: This file defines the SerializableFelt252Dict structure that allows us to use a Felt252Dict and serialize/deserialize it. </p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/span32.cairo">span32.cairo</a>: Provides utility functions for managing and manipulating fixed-size arrays (span32). A wrapper around Span type with a maximum size of 32. Used to prevent size overflow when storing Span.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/starknet_utils.cairo">starknet_utils.cairo</a>: This puts in place fake utilities to mimic Starknet environment features, like <code>gasleft</code> and <code>tx.gasprice</code>, in the Satoru Starknet smart contract environment. These functions give back set values based on the given parameters, allowing a way to mimic Starknet gas actions during testing and development.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/store_arrays.cairo">store_arrays.cairo</a>: This gives ways to read and write different kinds of lists, including lists of <code>ContractAddress</code>, <code>Market</code>, <code>Price</code>, <code>u128</code>, <code>u64</code>, and <code>felt252</code>, to and from Starknet storage. This tool helps in storing different kinds of data in an organized way, allowing easy access and changes, which are key for the smart contracts in the Satoru project to work.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/traits.cairo">traits.cairo</a>: This file has a way to make a default <code>ContractAddress</code> type from the Starknet library. It uses the <code>Default</code> trait to give a method, <code>default()</code>, that returns a <code>ContractAddress</code> set to <code>0</code>. This is useful when you need to make a <code>ContractAddress</code> with a default value when there is no specific address given.</p>
</li>
<li>
<p><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/utils/u128_mask.cairo">u128_mask.cairo</a>: This file creates a <code>Mask</code> structure to check if a given index is unique within a range of 128 bits. The <code>Mask</code> has a <code>bits</code> field representing a 128-bit unsigned number. The <code>validate_unique_and_set_index</code> function checks if the bit at a specific index is unique and not set; if it’s already set or out of bounds, it will cause an error. If not, it sets the bit at that index, showing that this index is now taken. This tool is useful for managing and confirming the uniqueness of indices in a 128-bit range.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="withdrawal-module"><a class="header" href="#withdrawal-module">Withdrawal Module</a></h1>
<p>The Withdrawal Module role is to manage the operations related to withdrawals.</p>
<h2 id="smart-contracts-4"><a class="header" href="#smart-contracts-4">Smart Contracts</a></h2>
<h3 id="withdrawalvault"><a class="header" href="#withdrawalvault"><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/withdrawal/withdrawal_vault.cairo">WithdrawalVault</a></a></h3>
<p>The WithdrawalVault is the vault specifically designed for withdrawals, ensuring the secure management of funds during the withdrawal processes.</p>
<h2 id="cairo-library-files-5"><a class="header" href="#cairo-library-files-5">Cairo Library Files</a></h2>
<ul>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/withdrawal/error.cairo">error.cairo</a>: Holds the module-specific error codes.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/withdrawal/withdrawal_utils.cairo">withdrawal_utils.cairo</a>: Encapsulates withdrawal-related utility functions.</li>
<li><a href="https://github.com/keep-starknet-strange/satoru/blob/main/src/withdrawal/withdrawal.cairo">withdrawal.cairo</a>: Defines the structures related to withdrawal.</li>
</ul>
<h3 id="withdrawal-creation-and-execution"><a class="header" href="#withdrawal-creation-and-execution">Withdrawal Creation and Execution</a></h3>
<p>In this module, withdrawals can be created through the <code>create_withdrawal</code> function, which needs parameters such as the account initiating the withdrawal, the receiver of the tokens, and various other details related to the withdrawal.</p>
<p>Execution of withdrawals is handled by the <code>execute_withdrawal</code> function, requiring parameters such as the unique identifier of the withdrawal and the event emitter used to emit events.</p>
<h3 id="swap-mechanism"><a class="header" href="#swap-mechanism">Swap Mechanism</a></h3>
<p>The module includes a <code>swap</code> function, used to swap tokens within the context of executing withdrawals, ensuring the internal state changes are correct before calling external callbacks.</p>
<h2 id="structures-and-types-11"><a class="header" href="#structures-and-types-11">Structures and Types</a></h2>
<h3 id="storage-2"><a class="header" href="#storage-2"><code>Storage</code></a></h3>
<p>This structure holds the interface to interact with the <code>DataStore</code> contract.</p>
<ul>
<li><code>strict_bank</code>: Represents the interface to interact with the <code>IStrictBankDispatcher</code>.</li>
</ul>
<h3 id="withdrawal"><a class="header" href="#withdrawal"><code>Withdrawal</code></a></h3>
<p>This structure represents a withdrawal within the system, holding essential information related to a specific withdrawal operation. The structure includes the following fields:</p>
<ul>
<li><code>key</code>: A unique identifier of the withdrawal, represented as a <code>felt252</code> type.</li>
<li><code>account</code>: The account of the order, represented as a <code>ContractAddress</code>.</li>
<li><code>receiver</code>: The receiver for any token transfers, represented as a <code>ContractAddress</code>.</li>
<li><code>callback_contract</code>: The contract to call for callbacks, represented as a <code>ContractAddress</code>.</li>
<li><code>ui_fee_receiver</code>: The UI fee receiver, represented as a <code>ContractAddress</code>.</li>
<li><code>market</code>: The trading market, represented as a <code>ContractAddress</code>.</li>
<li><code>long_token_swap_path</code>: An array of market addresses to swap through for long tokens, represented as a <code>Span32&lt;ContractAddress&gt;</code>.</li>
<li><code>short_token_swap_path</code>: An array of market addresses to swap through for short tokens, represented as a <code>Span32&lt;ContractAddress&gt;</code>.</li>
<li><code>market_token_amount</code>: The amount of market tokens that will be withdrawn, represented as a <code>u128</code> type.</li>
<li><code>min_long_token_amount</code>: The minimum amount of long tokens that must be withdrawn, represented as a <code>u128</code> type.</li>
<li><code>min_short_token_amount</code>: The minimum amount of short tokens that must be withdrawn, represented as a <code>u128</code> type.</li>
<li><code>updated_at_block</code>: The block at which the withdrawal was last updated, represented as a <code>u64</code> type.</li>
<li><code>execution_fee</code>: The execution fee for the withdrawal, represented as a <code>u128</code> type.</li>
<li><code>callback_gas_limit</code>: The gas limit for calling the callback contract, represented as a <code>u128</code> type.</li>
</ul>
<h3 id="balance"><a class="header" href="#balance"><code>Balance</code></a></h3>
<p>Represents the balance of an asset and includes the following fields:</p>
<ul>
<li><code>amount</code>: The total amount of the asset, represented as a <code>u128</code> type.</li>
<li><code>locked</code>: The amount of the asset that is locked, represented as a <code>u128</code> type.</li>
</ul>
<h3 id="asset"><a class="header" href="#asset"><code>Asset</code></a></h3>
<p>This structure represents an asset within the system and includes the following fields:</p>
<ul>
<li><code>symbol</code>: The symbol of the asset, represented as a string.</li>
<li><code>decimals</code>: The number of decimals the asset uses, represented as a <code>u8</code> type.</li>
<li><code>total_supply</code>: The total supply of the asset, represented as a <code>u128</code> type.</li>
</ul>
<h3 id="other-structures"><a class="header" href="#other-structures">Other Structures</a></h3>
<ul>
<li><code>CreateWithdrawalParams</code>: Holds parameters needed for creating a withdrawal, such as the receiver and the market on which the withdrawal will be executed.</li>
<li><code>ExecuteWithdrawalParams</code>: Holds parameters needed for executing a withdrawal, such as the data store where withdrawal data is stored and the unique identifier of the withdrawal to execute.</li>
<li><code>ExecuteWithdrawalCache</code>: Utilized to cache the results temporarily when executing a withdrawal.</li>
<li><code>ExecuteWithdrawalResult</code>: Represents the result of a withdrawal execution, holding details of the output token and its amount.</li>
<li><code>SwapCache</code>: Holds data related to token swap operations, such as the swap path markets and the output token and its amount.</li>
</ul>
<h2 id="functions-13"><a class="header" href="#functions-13">Functions</a></h2>
<h3 id="initialize-1"><a class="header" href="#initialize-1"><code>initialize</code></a></h3>
<p>This function is utilized to initialize the contract with the address of the strict bank contract.</p>
<h3 id="record_transfer_in"><a class="header" href="#record_transfer_in"><code>record_transfer_in</code></a></h3>
<p>Records the transfer in operation and returns a <code>u128</code> type representing the recorded value.</p>
<h3 id="transfer_out"><a class="header" href="#transfer_out"><code>transfer_out</code></a></h3>
<p>Executes the transfer out operation to the specified receiver with the defined amount.</p>
<h3 id="sync_token_balance"><a class="header" href="#sync_token_balance"><code>sync_token_balance</code></a></h3>
<p>Synchronizes the token balance and returns a <code>u128</code> type representing the synchronized value.</p>
<h2 id="errors-13"><a class="header" href="#errors-13">Errors</a></h2>
<p>The module employs <code>WithdrawalError</code> to address errors inherent to withdrawal operations. Here are the defined errors:</p>
<ul>
<li><code>ALREADY_INITIALIZED</code>: Triggered if the contract has already been initialized, represented by the constant <code>'already_initialized'</code>.</li>
<li><code>NOT_FOUND</code>: Triggered when a specified withdrawal is not found in the system, represented by the constant <code>'withdrawal not found'</code>.</li>
<li><code>CANT_BE_ZERO</code>: Triggered when a withdrawal account is zero, represented by the constant <code>'withdrawal account cant be 0'</code>.</li>
<li><code>EMPTY_WITHDRAWAL_AMOUNT</code>: Occurs when an attempt is made to withdraw an empty amount, represented by the constant <code>'empty withdrawal amount'</code>.</li>
<li><code>EMPTY_WITHDRAWAL</code>: Occurs when a withdrawal is empty, represented by the constant <code>'empty withdrawal'</code>.</li>
</ul>
<p>Additionally, the module defines several panic functions to handle specific error scenarios with more context:</p>
<ul>
<li><code>INSUFFICIENT_FEE_TOKEN_AMOUNT(data_1: u128, data_2: u128)</code>: Triggered when there is an insufficient amount of fee tokens, providing additional context with <code>data_1</code> and <code>data_2</code>.</li>
<li><code>INSUFFICIENT_MARKET_TOKENS(data_1: u128, data_2: u128)</code>: Triggered when there are insufficient market tokens available, providing additional context with <code>data_1</code> and <code>data_2</code>.</li>
<li><code>INVALID_POOL_VALUE_FOR_WITHDRAWAL(data: u128)</code>: Triggered when an invalid pool value is provided for withdrawal, providing additional context with <code>data</code>.</li>
<li><code>INVALID_WITHDRAWAL_KEY(data: felt252)</code>: Triggered when an invalid withdrawal key is provided, providing additional context with <code>data</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="continuous-integration"><a class="header" href="#continuous-integration">Continuous Integration</a></h1>
<h2 id="workflows"><a class="header" href="#workflows">Workflows</a></h2>
<p>A workflow is a configurable automated process that will run one or more jobs. Workflows are defined by a YAML file checked in to your repository and will run when triggered by an event in your repository, or they can be triggered manually, or at a defined schedule.</p>
<p>In this section we will run through every workflow and give a detailed explanation of their functionalities.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="github-workflows-documentation"><a class="header" href="#github-workflows-documentation">Github Workflows Documentation</a></h1>
<h2 id="satoru-book-workflow-documentation"><a class="header" href="#satoru-book-workflow-documentation">Satoru Book Workflow Documentation</a></h2>
<h3 id="overview-2"><a class="header" href="#overview-2">Overview:</a></h3>
<p>The &quot;Satoru Book&quot; GitHub Actions workflow (<code>book.yml</code>) is specifically designed for the automated build and deployment of the Satoru book's latest version.</p>
<h3 id="workflow-details"><a class="header" href="#workflow-details">Workflow Details:</a></h3>
<p><strong>Workflow Name:</strong> Satoru Book</p>
<p><strong>Trigger Conditions:</strong></p>
<ol>
<li><strong>Push Event:</strong> Activated when changes are pushed to the <code>main</code> branch.</li>
<li><strong>Pull Request Event:</strong> Activated for every pull request.</li>
</ol>
<p><strong>Jobs:</strong></p>
<ol>
<li><strong>Book Build &amp; Deploy Job</strong>:
<ul>
<li><strong>Environment:</strong> Ubuntu 20.04</li>
<li><strong>Concurrency:</strong> Ensures that only one job runs at a time per branch or pull request, preventing potential conflicts.</li>
<li><strong>Steps:</strong>
<ol>
<li><strong>Checkout Repository</strong>: Fetches the repository's content.</li>
<li><strong>Setup mdBook</strong>: Initializes mdBook, a utility for creating online books from markdown files. It uses the latest available version.</li>
<li><strong>Build mdBook</strong>: Constructs the online book using mdBook from the source files located in the <code>./book</code> directory.</li>
<li><strong>Deploy</strong>: If the trigger branch is <code>main</code>, the built book is deployed to GitHub Pages using the specified token. The content to be published is sourced from the <code>./book/book</code> directory.</li>
</ol>
</li>
</ul>
</li>
</ol>
<pre><code class="language-yml">name: Satoru Book

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  book:
    runs-on: ubuntu-20.04
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - uses: actions/checkout@v2

      - name: Setup mdBook
        uses: peaceiris/actions-mdbook@v1
        with:
          mdbook-version: 'latest'

      - run: mdbook build
        working-directory: ./book

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ github.ref == 'refs/heads/main' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./book/book
</code></pre>
<h2 id="build-workflow-documentation"><a class="header" href="#build-workflow-documentation">Build Workflow Documentation</a></h2>
<h3 id="overview-3"><a class="header" href="#overview-3">Overview:</a></h3>
<p>The &quot;Build&quot; GitHub Actions workflow (<code>build.yml</code>) is made for building Cairo files using Scarb and checking their format.</p>
<h3 id="workflow-details-1"><a class="header" href="#workflow-details-1">Workflow Details:</a></h3>
<p><strong>Workflow Name:</strong> Build</p>
<p><strong>Trigger Conditions:</strong></p>
<ol>
<li><strong>Push Event:</strong> Activated when changes are pushed to the <code>main</code> branch.</li>
<li><strong>Pull Request Event:</strong> Triggered for every pull request targeting the <code>main</code> branch.</li>
</ol>
<p><strong>Environment Variables:</strong></p>
<ul>
<li><strong>SCARB_VERSION:</strong> Specifies the version of Scarb to be used, currently set to <code>0.7.0</code>.</li>
</ul>
<blockquote>
<p><strong>Note:</strong> Currently, we are utilizing the nightly versions of Scarb to leverage the latest features of Cairo. The installation process is slightly different than using non-nightly versions. Once Cairo and Scarb stabilize, we will migrate to stable versions and employ the <code>software-mansion/setup-scarb</code> action for easier setup.</p>
</blockquote>
<p><strong>Jobs:</strong></p>
<ol>
<li><strong>Cairo Check &amp; Build Job</strong>:
<ul>
<li><strong>Environment:</strong> Latest version of Ubuntu.</li>
<li><strong>Steps:</strong>
<ol>
<li><strong>Checkout Repository</strong>: Fetches the repository's content.</li>
<li><strong>Set up Scarb</strong>: Instead of using the conventional setup action, we fetch the nightly version of Scarb directly from its release page and place the binary in the required path.</li>
<li><strong>Check Cairo Format</strong>: Ensures the Cairo files follow the expected format.</li>
<li><strong>Build Cairo Programs</strong>: Compiles the Cairo files.</li>
</ol>
</li>
</ul>
</li>
</ol>
<pre><code class="language-yml">name: Build

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
env:
  SCARB_VERSION: 0.7.0

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: software-mansion/setup-scarb@v1
        with:
          scarb-version: &quot;0.7.0&quot;
      - name: Check cairo format
        run: scarb fmt --check
      - name: Build cairo programs
        run: scarb build
</code></pre>
<h2 id="security-workflow-documentation"><a class="header" href="#security-workflow-documentation">Security Workflow Documentation</a></h2>
<h3 id="overview-4"><a class="header" href="#overview-4">Overview:</a></h3>
<p>The &quot;Security&quot; GitHub Actions workflow (<code>security.yml</code>) is designed to enforce security standards and conduct safety checks on the codebase. It ensures that code modifications follow best security practices and identifies potential vulnerabilities.</p>
<h3 id="workflow-details-2"><a class="header" href="#workflow-details-2">Workflow Details:</a></h3>
<p><strong>Workflow Name:</strong> Security</p>
<p><strong>Trigger Conditions:</strong></p>
<ol>
<li><strong>Push Event:</strong> Activated when changes are pushed to the <code>main</code> branch.</li>
<li><strong>Pull Request Event:</strong> Triggered for every pull request targeting the <code>main</code> branch.</li>
</ol>
<p><strong>Jobs:</strong></p>
<ol>
<li><strong>Security Check Job</strong>:
<ul>
<li><strong>Environment:</strong> Latest version of Ubuntu.</li>
<li><strong>Steps:</strong>
<ol>
<li><strong>Checkout Repository</strong>: Retrieves the repository's content.</li>
<li><strong>Install Semgrep</strong>: Installs Semgrep, a static code analysis tool, to identify potential security issues.</li>
<li><strong>Run Semgrep</strong>: Executes Semgrep with a custom configuration sourced from a release of <code>semgrep-cairo-rules</code>. Results are written to <code>semgrep-output.txt</code>.</li>
<li><strong>Save Semgrep Output</strong>: Archives the Semgrep results as an artifact named <code>semgrep-cairo</code>.</li>
</ol>
</li>
</ul>
</li>
</ol>
<pre><code class="language-yml">name: Security

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Semgrep
        run: |
          pip install semgrep
      - name: Run Semgrep
        run: semgrep --config https://github.com/avnu-labs/semgrep-cairo-rules/releases/download/v0.0.1/cairo-rules.yaml ./src &gt; semgrep-output.txt
      - name: Save Semgrep Output as an Artifact
        uses: actions/upload-artifact@v3
        with:
          name: semgrep-cairo
          path: semgrep-output.txt
</code></pre>
<h2 id="test-workflow-documentation"><a class="header" href="#test-workflow-documentation">Test Workflow Documentation</a></h2>
<h3 id="overview-5"><a class="header" href="#overview-5">Overview:</a></h3>
<p>The &quot;Test&quot; GitHub Actions workflow (<code>test.yml</code>) ensures the code's integrity by validating its functionality. It aims to detect any potential issues introduced by new code modifications, guaranteeing that they do not impact the existing codebase.</p>
<h3 id="workflow-details-3"><a class="header" href="#workflow-details-3">Workflow Details:</a></h3>
<p><strong>Workflow Name:</strong> Test</p>
<p><strong>Trigger Conditions:</strong></p>
<ol>
<li><strong>Push Event:</strong> Activated when changes are pushed to the <code>main</code> branch.</li>
<li><strong>Pull Request Event:</strong> Triggered for pull requests targeting the <code>main</code> branch.</li>
</ol>
<p><strong>Environment Variables:</strong></p>
<ul>
<li><strong>SCARB_VERSION:</strong> Specifies the Scarb version, currently set to <code>0.7.0</code>.</li>
<li><strong>STARKNET_FOUNDRY_VERSION:</strong> Defines the version of Starknet Foundry, currently set to <code>0.8.3</code>.</li>
</ul>
<p><strong>Jobs:</strong></p>
<ol>
<li><strong>Test &amp; Check Job</strong>:
<ul>
<li><strong>Environment:</strong> Latest version of Ubuntu.</li>
<li><strong>Steps:</strong>
<ol>
<li><strong>Checkout Repository</strong>: Retrieves the contents of the repository.</li>
<li><strong>Set up Scarb</strong>: Fetches the nightly version of Scarb directly from its release page and places the binary in the required path.</li>
<li><strong>Install Starknet Foundry</strong>: Installs the specified version of Starknet Foundry using a curl command.</li>
<li><strong>Run Cairo Tests</strong>: Executes tests using the <code>snforge</code> command.</li>
</ol>
</li>
</ul>
</li>
</ol>
<pre><code class="language-yml">name: Test

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
env:
  SCARB_VERSION: 0.7.0

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: foundry-rs/setup-snfoundry@v1
        with:
          starknet-foundry-version: 0.9.0
      - uses: software-mansion/setup-scarb@v1
        with:
          scarb-version: &quot;0.7.0&quot;
      - name: Run cairo tests
        run: snforge
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
